<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeaseSign - Texas Residential Lease E-Signature Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5; --primary-dark: #4338ca; --primary-light: #818cf8; --primary-50: #eef2ff;
            --success: #10b981; --success-light: #d1fae5;
            --warning: #f59e0b; --warning-light: #fef3c7;
            --danger: #ef4444; --danger-light: #fee2e2;
            --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb; --gray-300: #d1d5db;
            --gray-400: #9ca3af; --gray-500: #6b7280; --gray-600: #4b5563; --gray-700: #374151;
            --gray-800: #1f2937; --gray-900: #111827;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--gray-50); color: var(--gray-800); min-height: 100vh; }
        
        .top-nav { background: white; border-bottom: 1px solid var(--gray-200); padding: 0 2rem; height: 64px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .logo { display: flex; align-items: center; gap: 0.75rem; font-family: 'DM Sans', sans-serif; font-weight: 700; font-size: 1.5rem; color: var(--primary); cursor: pointer; }
        .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem; }
        
        .app-layout { display: flex; min-height: calc(100vh - 64px); }
        .sidebar { width: 260px; background: white; border-right: 1px solid var(--gray-200); padding: 1.5rem 0; flex-shrink: 0; }
        .sidebar-label { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-400); padding: 0 1.5rem; margin: 1.5rem 0 0.5rem; }
        .sidebar-label:first-child { margin-top: 0; }
        .sidebar-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1.5rem; color: var(--gray-600); cursor: pointer; transition: all 0.15s; border-left: 3px solid transparent; font-size: 0.9375rem; }
        .sidebar-item:hover { background: var(--gray-50); color: var(--gray-800); }
        .sidebar-item.active { background: var(--primary-50); color: var(--primary); border-left-color: var(--primary); font-weight: 500; }
        .sidebar-item svg { width: 20px; height: 20px; flex-shrink: 0; }
        .sidebar-badge { margin-left: auto; background: var(--primary); color: white; font-size: 0.7rem; font-weight: 600; padding: 0.125rem 0.5rem; border-radius: 9999px; min-width: 20px; text-align: center; }
        .main-content { flex: 1; padding: 2rem; overflow-y: auto; max-width: 1200px; }
        
        .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        .page-title { font-family: 'DM Sans', sans-serif; font-size: 1.75rem; font-weight: 700; color: var(--gray-900); }
        .page-subtitle { color: var(--gray-500); margin-top: 0.25rem; }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.625rem 1.25rem; font-size: 0.875rem; font-weight: 500; border-radius: 8px; border: none; cursor: pointer; transition: all 0.15s; font-family: inherit; text-decoration: none; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--primary-dark); }
        .btn-secondary { background: white; color: var(--gray-700); border: 1px solid var(--gray-300); }
        .btn-secondary:hover:not(:disabled) { background: var(--gray-50); border-color: var(--gray-400); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover:not(:disabled) { background: #059669; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover:not(:disabled) { background: #d97706; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover:not(:disabled) { background: #dc2626; }
        .btn-ghost { background: transparent; color: var(--gray-600); }
        .btn-ghost:hover:not(:disabled) { background: var(--gray-100); }
        .btn-lg { padding: 0.875rem 1.75rem; font-size: 1rem; }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8125rem; }
        .btn-icon { padding: 0.5rem; }
        
        .card { background: white; border-radius: 12px; border: 1px solid var(--gray-200); overflow: hidden; }
        .card-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--gray-100); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .card-title { font-weight: 600; color: var(--gray-900); }
        .card-body { padding: 1.5rem; }
        
        .status-badge { display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 500; border-radius: 9999px; }
        .status-draft { background: var(--gray-100); color: var(--gray-600); }
        .status-pending { background: var(--warning-light); color: #92400e; }
        .status-partial { background: #dbeafe; color: #1e40af; }
        .status-completed { background: var(--success-light); color: #065f46; }
        .status-voided { background: var(--danger-light); color: #991b1b; }
        .status-template { background: #e0e7ff; color: #3730a3; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
        
        .doc-list { display: flex; flex-direction: column; }
        .doc-item { display: flex; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--gray-100); cursor: pointer; transition: background 0.15s; gap: 1rem; }
        .doc-item:hover { background: var(--gray-50); }
        .doc-item:last-child { border-bottom: none; }
        .doc-icon { width: 48px; height: 48px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
        .doc-icon.template { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); }
        .doc-info { flex: 1; min-width: 0; }
        .doc-title { font-weight: 600; color: var(--gray-900); margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .doc-meta { font-size: 0.875rem; color: var(--gray-500); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: white; border-radius: 12px; border: 1px solid var(--gray-200); padding: 1.25rem; }
        .stat-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; margin-bottom: 0.75rem; }
        .stat-icon.blue { background: #dbeafe; }
        .stat-icon.yellow { background: #fef3c7; }
        .stat-icon.green { background: #d1fae5; }
        .stat-icon.red { background: #fee2e2; }
        .stat-icon.gray { background: var(--gray-100); }
        .stat-icon.purple { background: #e0e7ff; }
        .stat-label { font-size: 0.8rem; color: var(--gray-500); margin-bottom: 0.125rem; }
        .stat-value { font-family: 'DM Sans', sans-serif; font-size: 1.75rem; font-weight: 700; color: var(--gray-900); }
        
        .form-section { margin-bottom: 2rem; }
        .form-section-title { font-weight: 600; color: var(--gray-900); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--gray-200); display: flex; align-items: center; gap: 0.5rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        .form-group { margin-bottom: 0; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.375rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.625rem 0.875rem; font-size: 0.9375rem; border: 1px solid var(--gray-300); border-radius: 8px; transition: all 0.15s; font-family: inherit; background: white; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .form-group input:disabled { background: var(--gray-100); }
        .form-hint { font-size: 0.8rem; color: var(--gray-500); margin-top: 0.25rem; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal { background: white; border-radius: 16px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-lg { max-width: 900px; }
        .modal-sm { max-width: 450px; }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; z-index: 1; }
        .modal-title { font-family: 'DM Sans', sans-serif; font-size: 1.25rem; font-weight: 700; }
        .modal-close { width: 36px; height: 36px; border-radius: 8px; border: none; background: var(--gray-100); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; color: var(--gray-500); }
        .modal-close:hover { background: var(--gray-200); }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1.5rem; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 0.75rem; position: sticky; bottom: 0; background: white; }
        
        .tabs { display: flex; border-bottom: 1px solid var(--gray-200); margin-bottom: 1.5rem; overflow-x: auto; }
        .tab { padding: 0.75rem 1.25rem; font-weight: 500; color: var(--gray-500); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.15s; white-space: nowrap; }
        .tab:hover { color: var(--gray-700); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        .timeline { padding: 1rem 0; }
        .timeline-item { display: flex; gap: 1rem; padding-bottom: 1.5rem; position: relative; }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-item:not(:last-child)::before { content: ''; position: absolute; left: 15px; top: 32px; bottom: 0; width: 2px; background: var(--gray-200); }
        .timeline-dot { width: 32px; height: 32px; border-radius: 50%; background: var(--gray-200); display: flex; align-items: center; justify-content: center; flex-shrink: 0; z-index: 1; font-size: 0.875rem; font-weight: 600; color: var(--gray-500); }
        .timeline-dot.success { background: var(--success); color: white; }
        .timeline-dot.pending { background: var(--warning); color: white; }
        .timeline-content { flex: 1; padding-top: 4px; }
        .timeline-title { font-weight: 500; margin-bottom: 0.125rem; }
        .timeline-meta { font-size: 0.875rem; color: var(--gray-500); }
        
        .signature-area { border: 2px dashed var(--primary); border-radius: 12px; padding: 2rem; margin: 1.5rem 0; background: rgba(79, 70, 229, 0.02); text-align: center; }
        .signature-area.signed { border-style: solid; border-color: var(--success); background: rgba(16, 185, 129, 0.02); }
        .signature-label { font-size: 0.875rem; color: var(--gray-500); margin-bottom: 1rem; }
        .signature-canvas-wrap { background: white; border: 1px solid var(--gray-300); border-radius: 8px; margin-bottom: 1rem; display: inline-block; max-width: 100%; overflow: hidden; }
        .signature-canvas { width: 400px; max-width: 100%; height: 150px; cursor: crosshair; touch-action: none; display: block; }
        .signature-actions { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
        .signature-image { max-height: 80px; margin-bottom: 0.5rem; }
        
        .alert { padding: 1rem 1.25rem; border-radius: 8px; margin-bottom: 1rem; display: flex; gap: 0.75rem; align-items: flex-start; }
        .alert-icon { font-size: 1.25rem; flex-shrink: 0; }
        .alert-info { background: #dbeafe; color: #1e40af; }
        .alert-warning { background: var(--warning-light); color: #92400e; }
        .alert-success { background: var(--success-light); color: #065f46; }
        .alert-danger { background: var(--danger-light); color: #991b1b; }
        
        .doc-preview { background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 2rem; font-family: 'Times New Roman', serif; font-size: 11pt; line-height: 1.5; max-height: 500px; overflow-y: auto; }
        .doc-preview h1 { text-align: center; font-size: 16pt; margin-bottom: 0.5rem; font-family: 'Times New Roman', serif; }
        .doc-preview .subtitle { text-align: center; font-size: 9pt; color: #666; margin-bottom: 1.5rem; }
        .doc-preview .section { margin-bottom: 1rem; }
        .doc-preview .section-title { font-weight: bold; }
        .doc-preview .field { border-bottom: 1px solid #000; padding: 0 4px; background: #fffbeb; font-weight: bold; }
        
        .toast-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 1001; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { background: var(--gray-900); color: white; padding: 1rem 1.5rem; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); animation: slideIn 0.3s ease; min-width: 280px; max-width: 400px; }
        .toast-success { background: var(--success); }
        .toast-error { background: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem; background: linear-gradient(135deg, var(--primary-50) 0%, white 100%); }
        .auth-card { background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); padding: 3rem; max-width: 420px; width: 100%; }
        .auth-logo { text-align: center; margin-bottom: 2rem; }
        .auth-title { font-family: 'DM Sans', sans-serif; font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 0.5rem; }
        .auth-subtitle { color: var(--gray-500); text-align: center; margin-bottom: 2rem; }
        .auth-footer { text-align: center; margin-top: 1.5rem; color: var(--gray-500); }
        .auth-footer a { color: var(--primary); text-decoration: none; font-weight: 500; cursor: pointer; }
        .auth-footer a:hover { text-decoration: underline; }
        
        .signing-container { max-width: 900px; margin: 0 auto; padding: 2rem; }
        .signing-header { background: white; border-radius: 12px; border: 1px solid var(--gray-200); padding: 1.5rem; margin-bottom: 1.5rem; }
        
        .empty-state { text-align: center; padding: 4rem 2rem; }
        .empty-state-icon { width: 80px; height: 80px; background: var(--gray-100); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; font-size: 2rem; }
        .empty-state h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .empty-state p { color: var(--gray-500); margin-bottom: 1.5rem; }
        
        .user-menu { position: relative; }
        .user-btn { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; background: var(--gray-100); border: none; border-radius: 9999px; cursor: pointer; font-family: inherit; }
        .user-avatar { width: 32px; height: 32px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.875rem; }
        .user-dropdown { position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background: white; border: 1px solid var(--gray-200); border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); min-width: 200px; z-index: 100; overflow: hidden; }
        .user-dropdown-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; color: var(--gray-700); cursor: pointer; transition: background 0.15s; border: none; background: none; width: 100%; text-align: left; font-family: inherit; font-size: 0.9375rem; }
        .user-dropdown-item:hover { background: var(--gray-50); }
        .user-dropdown-item.danger { color: var(--danger); }
        
        .detail-grid { display: grid; grid-template-columns: 1fr 340px; gap: 1.5rem; }
        .action-bar { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-menu { position: absolute; top: 100%; right: 0; margin-top: 0.25rem; background: white; border: 1px solid var(--gray-200); border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); min-width: 180px; z-index: 100; overflow: hidden; display: none; }
        .dropdown-menu.show { display: block; }
        .dropdown-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1rem; color: var(--gray-700); cursor: pointer; transition: background 0.15s; font-size: 0.875rem; }
        .dropdown-item:hover { background: var(--gray-50); }
        .dropdown-item.danger { color: var(--danger); }
        .dropdown-divider { height: 1px; background: var(--gray-200); margin: 0.25rem 0; }
        
        @media (max-width: 900px) { .detail-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { 
            .sidebar { display: none; }
            .main-content { padding: 1rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // API Helper
        const api = {
            token: localStorage.getItem('leasesign_token'),
            setToken(t) { this.token = t; t ? localStorage.setItem('leasesign_token', t) : localStorage.removeItem('leasesign_token'); },
            async req(url, opts = {}) {
                const headers = { 'Content-Type': 'application/json', ...opts.headers };
                if (this.token) headers['Authorization'] = `Bearer ${this.token}`;
                const res = await fetch(`/api${url}`, { ...opts, headers });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data.error || 'Request failed');
                return data;
            },
            get: (url) => api.req(url),
            post: (url, body) => api.req(url, { method: 'POST', body: JSON.stringify(body) }),
            put: (url, body) => api.req(url, { method: 'PUT', body: JSON.stringify(body) }),
            del: (url) => api.req(url, { method: 'DELETE' })
        };

        // Icons
        const Icon = ({ name, size = 20 }) => {
            const paths = {
                home: 'M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z M9 22V12h6v10',
                folder: 'M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z',
                plus: 'M12 5v14 M5 12h14',
                send: 'M22 2L11 13 M22 2l-7 20-4-9-9-4 20-7z',
                check: 'M20 6L9 17l-5-5',
                download: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3',
                trash: 'M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2',
                user: 'M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8z',
                logout: 'M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-5-5-5 M21 12H9',
                back: 'M19 12H5 M12 19l-7-7 7-7',
                copy: 'M20 9h-9a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2v-9a2 2 0 0 0-2-2z M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1',
                refresh: 'M23 4v6h-6 M1 20v-6h6 M3.51 9a9 9 0 0 1 14.85-3.36L23 10 M1 14l4.64 4.36A9 9 0 0 0 20.49 15',
                x: 'M18 6L6 18 M6 6l12 12',
                more: 'M12 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2z M19 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2z M5 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2z',
                template: 'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z M14 2v6h6 M16 13H8 M16 17H8 M10 9H8',
                ban: 'M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z M4.93 4.93l14.14 14.14',
                edit: 'M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7 M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z',
                search: 'M11 17a6 6 0 1 0 0-12 6 6 0 0 0 0 12z M21 21l-4.35-4.35',
                chart: 'M18 20V10 M12 20V4 M6 20v-6'
            };
            return <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d={paths[name]}/></svg>;
        };

        // Signature Pad
        function SignaturePad({ onComplete, signerName }) {
            const canvasRef = useRef(null);
            const [drawing, setDrawing] = useState(false);
            const [hasSig, setHasSig] = useState(false);

            useEffect(() => {
                const ctx = canvasRef.current.getContext('2d');
                ctx.strokeStyle = '#1f2937';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
            }, []);

            const getPos = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const scaleX = canvasRef.current.width / rect.width;
                const scaleY = canvasRef.current.height / rect.height;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
            };

            const start = (e) => { e.preventDefault(); const ctx = canvasRef.current.getContext('2d'); const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); setDrawing(true); };
            const draw = (e) => { if (!drawing) return; e.preventDefault(); const ctx = canvasRef.current.getContext('2d'); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); setHasSig(true); };
            const stop = () => setDrawing(false);
            const clear = () => { canvasRef.current.getContext('2d').clearRect(0, 0, 400, 150); setHasSig(false); };

            return (
                <div className="signature-area">
                    <div className="signature-label">‚úçÔ∏è Sign here: <strong>{signerName}</strong></div>
                    <div className="signature-canvas-wrap">
                        <canvas ref={canvasRef} className="signature-canvas" width={400} height={150}
                            onMouseDown={start} onMouseMove={draw} onMouseUp={stop} onMouseLeave={stop}
                            onTouchStart={start} onTouchMove={draw} onTouchEnd={stop}/>
                    </div>
                    <div className="signature-actions">
                        <button className="btn btn-secondary" onClick={clear}>Clear</button>
                        <button className="btn btn-primary" onClick={() => hasSig && onComplete(canvasRef.current.toDataURL())} disabled={!hasSig}>Adopt & Sign</button>
                    </div>
                    <p style={{fontSize:'0.8rem',color:'var(--gray-500)',marginTop:'1rem'}}>By signing, I agree that this electronic signature is the legal equivalent of my manual signature.</p>
                </div>
            );
        }

        // Toast
        function Toasts({ toasts, remove }) {
            return <div className="toast-container">{toasts.map(t => <div key={t.id} className={`toast toast-${t.type}`} onClick={() => remove(t.id)}>{t.type === 'success' ? '‚úì' : '‚úï'} {t.message}</div>)}</div>;
        }

        // Status Badge
        const StatusBadge = ({ status }) => {
            const cfg = { 
                draft: ['status-draft', 'Draft'], 
                pending: ['status-pending', 'Awaiting Signatures'], 
                partial: ['status-partial', 'Partially Signed'], 
                completed: ['status-completed', 'Completed'],
                voided: ['status-voided', 'Voided'],
                template: ['status-template', 'Template']
            };
            const [cls, label] = cfg[status] || cfg.draft;
            return <span className={`status-badge ${cls}`}><span className="status-dot"></span>{label}</span>;
        };

        // Login Page
        function LoginPage({ onLogin, onSwitch }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const submit = async (e) => {
                e.preventDefault();
                setLoading(true); setError('');
                try {
                    const { token, user } = await api.post('/auth/login', { email, password });
                    api.setToken(token);
                    onLogin(user);
                } catch (err) { setError(err.message); }
                finally { setLoading(false); }
            };

            return (
                <div className="auth-container">
                    <div className="auth-card">
                        <div className="auth-logo"><div className="logo" style={{justifyContent:'center'}}><div className="logo-icon">üìù</div>LeaseSign</div></div>
                        <h1 className="auth-title">Welcome back</h1>
                        <p className="auth-subtitle">Sign in to manage your lease documents</p>
                        {error && <div className="alert alert-danger"><span className="alert-icon">‚ö†Ô∏è</span>{error}</div>}
                        <form onSubmit={submit}>
                            <div className="form-group" style={{marginBottom:'1rem'}}><label>Email</label><input type="email" value={email} onChange={e=>setEmail(e.target.value)} required/></div>
                            <div className="form-group" style={{marginBottom:'1rem'}}><label>Password</label><input type="password" value={password} onChange={e=>setPassword(e.target.value)} required/></div>
                            <button type="submit" className="btn btn-primary btn-lg" style={{width:'100%'}} disabled={loading}>{loading ? 'Signing in...' : 'Sign In'}</button>
                        </form>
                        <div className="auth-footer">Don't have an account? <a onClick={onSwitch}>Create one</a></div>
                    </div>
                </div>
            );
        }

        // Register Page
        function RegisterPage({ onRegister, onSwitch }) {
            const [form, setForm] = useState({ email: '', password: '', name: '', company: '', phone: '' });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const submit = async (e) => {
                e.preventDefault();
                setLoading(true); setError('');
                try {
                    const { token, user } = await api.post('/auth/register', form);
                    api.setToken(token);
                    onRegister(user);
                } catch (err) { setError(err.message); }
                finally { setLoading(false); }
            };

            return (
                <div className="auth-container">
                    <div className="auth-card">
                        <div className="auth-logo"><div className="logo" style={{justifyContent:'center'}}><div className="logo-icon">üìù</div>LeaseSign</div></div>
                        <h1 className="auth-title">Create account</h1>
                        <p className="auth-subtitle">Start managing lease documents today</p>
                        {error && <div className="alert alert-danger"><span className="alert-icon">‚ö†Ô∏è</span>{error}</div>}
                        <form onSubmit={submit}>
                            <div className="form-group" style={{marginBottom:'1rem'}}><label>Full Name *</label><input value={form.name} onChange={e=>setForm({...form,name:e.target.value})} required/></div>
                            <div className="form-group" style={{marginBottom:'1rem'}}><label>Email *</label><input type="email" value={form.email} onChange={e=>setForm({...form,email:e.target.value})} required/></div>
                            <div className="form-group" style={{marginBottom:'1rem'}}><label>Password *</label><input type="password" value={form.password} onChange={e=>setForm({...form,password:e.target.value})} required minLength={6}/></div>
                            <div className="form-group" style={{marginBottom:'1rem'}}><label>Company</label><input value={form.company} onChange={e=>setForm({...form,company:e.target.value})}/></div>
                            <div className="form-group" style={{marginBottom:'1rem'}}><label>Phone</label><input value={form.phone} onChange={e=>setForm({...form,phone:e.target.value})}/></div>
                            <button type="submit" className="btn btn-primary btn-lg" style={{width:'100%'}} disabled={loading}>{loading ? 'Creating...' : 'Create Account'}</button>
                        </form>
                        <div className="auth-footer">Already have an account? <a onClick={onSwitch}>Sign in</a></div>
                    </div>
                </div>
            );
        }

        // Create/Edit Lease Modal
        function CreateModal({ onClose, onCreate, onUpdate, user, template, editDoc }) {
            const isEditing = !!editDoc;
            const source = editDoc || template;
            const [step, setStep] = useState(1);
            const [form, setForm] = useState({
                title: source?.title || '',
                landlordName: source?.landlordName || user.name,
                landlordEmail: source?.landlordEmail || user.email,
                landlordPhone: source?.landlordPhone || user.phone || '',
                landlordAddress: source?.landlordAddress || '',
                tenantName: source?.tenantName || '',
                tenantEmail: source?.tenantEmail || '',
                tenantPhone: source?.tenantPhone || '',
                additionalTenants: source?.additionalTenants || [],
                additionalOccupants: source?.additionalOccupants || '',
                propertyAddress: template?.propertyAddress || '',
                propertyCity: template?.propertyCity || '',
                propertyZip: template?.propertyZip || '',
                propertyCounty: template?.propertyCounty || '',
                legalDescription: template?.legalDescription || '',
                propertyType: template?.propertyType || 'single-family',
                bedrooms: template?.bedrooms || '',
                bathrooms: template?.bathrooms || '',
                squareFeet: template?.squareFeet || '',
                parkingSpaces: template?.parkingSpaces || '2',
                commencementDate: template?.commencementDate || '',
                expirationDate: template?.expirationDate || '',
                monthlyRent: template?.monthlyRent || '',
                securityDeposit: template?.securityDeposit || '',
                proratedRent: template?.proratedRent || '',
                proratedDueDate: template?.proratedDueDate || '',
                gracePeriodDay: template?.gracePeriodDay || '3',
                initialLateFee: template?.initialLateFee || '50',
                dailyLateFee: template?.dailyLateFee || '25',
                returnedPaymentFee: template?.returnedPaymentFee || '75',
                paymentName: template?.paymentName || '',
                paymentAddress: template?.paymentAddress || '',
                paymentMethods: template?.paymentMethods || ['check', 'electronic'],
                petsAllowed: template?.petsAllowed || false,
                petDeposit: template?.petDeposit || '',
                petRent: source?.petRent || '',
                allowedPets: source?.allowedPets || '',
                smokingAllowed: source?.smokingAllowed || false,
                utilitiesTenant: source?.utilitiesTenant || ['electric', 'gas', 'water', 'trash', 'internet'],
                utilitiesLandlord: source?.utilitiesLandlord || [],
                hoaName: source?.hoaName || '',
                accessNoticeHours: source?.accessNoticeHours || '24',
                terminationNoticeDays: source?.terminationNoticeDays || '30',
                specialProvisions: source?.specialProvisions || ''
            });
            const upd = (k, v) => setForm({ ...form, [k]: v });
            const toggleArray = (arr, val) => arr.includes(val) ? arr.filter(x => x !== val) : [...arr, val];

            const addTenant = () => {
                upd('additionalTenants', [...form.additionalTenants, { name: '', email: '', phone: '' }]);
            };
            const updateTenant = (idx, field, value) => {
                const tenants = [...form.additionalTenants];
                tenants[idx] = { ...tenants[idx], [field]: value };
                upd('additionalTenants', tenants);
            };
            const removeTenant = (idx) => {
                upd('additionalTenants', form.additionalTenants.filter((_, i) => i !== idx));
            };

            const submit = () => {
                const title = form.title || `Lease for ${form.propertyAddress?.split(',')[0] || 'New Property'}`;
                if (isEditing) {
                    onUpdate({ ...form, title });
                } else {
                    onCreate({ ...form, title });
                }
            };

            const Checkbox = ({ checked, onChange, label }) => (
                <label style={{display:'flex',alignItems:'center',gap:'0.5rem',cursor:'pointer',fontSize:'0.9rem'}}>
                    <input type="checkbox" checked={checked} onChange={onChange} style={{width:'18px',height:'18px',accentColor:'var(--primary)'}}/>
                    {label}
                </label>
            );

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal modal-lg" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">{isEditing ? 'Edit Lease' : template ? 'Create from Template' : 'Create New Lease'}</h2>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        <div className="modal-body">
                            <div className="tabs">
                                <div className={`tab ${step===1?'active':''}`} onClick={()=>setStep(1)}>1. Parties</div>
                                <div className={`tab ${step===2?'active':''}`} onClick={()=>setStep(2)}>2. Property</div>
                                <div className={`tab ${step===3?'active':''}`} onClick={()=>setStep(3)}>3. Lease Terms</div>
                                <div className={`tab ${step===4?'active':''}`} onClick={()=>setStep(4)}>4. Rent & Fees</div>
                                <div className={`tab ${step===5?'active':''}`} onClick={()=>setStep(5)}>5. Rules</div>
                                <div className={`tab ${step===6?'active':''}`} onClick={()=>setStep(6)}>6. Additional</div>
                            </div>

                            {step === 1 && <>
                                <div className="form-section">
                                    <h3 className="form-section-title">LANDLORD/OWNER INFORMATION</h3>
                                    <div className="form-grid">
                                        <div className="form-group"><label>Full Legal Name *</label><input value={form.landlordName} onChange={e=>upd('landlordName',e.target.value)} placeholder="John Smith"/></div>
                                        <div className="form-group"><label>Email Address *</label><input type="email" value={form.landlordEmail} onChange={e=>upd('landlordEmail',e.target.value)} placeholder="landlord@email.com"/></div>
                                        <div className="form-group"><label>Phone Number</label><input value={form.landlordPhone} onChange={e=>upd('landlordPhone',e.target.value)} placeholder="(512) 555-1234"/></div>
                                        <div className="form-group"><label>Mailing Address</label><input value={form.landlordAddress} onChange={e=>upd('landlordAddress',e.target.value)} placeholder="123 Main St, Austin, TX 78701"/></div>
                                    </div>
                                </div>
                                <div className="form-section">
                                    <h3 className="form-section-title">PRIMARY TENANT</h3>
                                    <div className="form-grid">
                                        <div className="form-group"><label>Full Legal Name *</label><input value={form.tenantName} onChange={e=>upd('tenantName',e.target.value)} placeholder="Jane Doe"/></div>
                                        <div className="form-group"><label>Email Address *</label><input type="email" value={form.tenantEmail} onChange={e=>upd('tenantEmail',e.target.value)} placeholder="tenant@email.com"/></div>
                                        <div className="form-group"><label>Phone Number</label><input value={form.tenantPhone} onChange={e=>upd('tenantPhone',e.target.value)} placeholder="(512) 555-5678"/></div>
                                    </div>
                                </div>
                                {form.additionalTenants.map((tenant, idx) => (
                                    <div className="form-section" key={idx} style={{background:'var(--gray-50)',padding:'1rem',borderRadius:'8px',marginBottom:'1rem'}}>
                                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.5rem'}}>
                                            <h3 className="form-section-title" style={{margin:0}}>ADDITIONAL TENANT {idx + 1}</h3>
                                            <button type="button" className="btn btn-secondary btn-sm" onClick={() => removeTenant(idx)} style={{color:'var(--danger)'}}>Remove</button>
                                        </div>
                                        <div className="form-grid">
                                            <div className="form-group"><label>Full Legal Name *</label><input value={tenant.name} onChange={e=>updateTenant(idx,'name',e.target.value)} placeholder="Co-tenant Name"/></div>
                                            <div className="form-group"><label>Email Address *</label><input type="email" value={tenant.email} onChange={e=>updateTenant(idx,'email',e.target.value)} placeholder="cotenant@email.com"/></div>
                                            <div className="form-group"><label>Phone Number</label><input value={tenant.phone} onChange={e=>updateTenant(idx,'phone',e.target.value)} placeholder="(512) 555-9999"/></div>
                                        </div>
                                    </div>
                                ))}
                                <button type="button" className="btn btn-secondary" onClick={addTenant} style={{marginBottom:'1rem'}}><Icon name="plus" size={16}/> Add Another Tenant</button>
                                <div className="form-section">
                                    <h3 className="form-section-title">OTHER OCCUPANTS</h3>
                                    <div className="form-group full-width"><label>Non-signing occupants (names of all other persons who will reside at property)</label><input value={form.additionalOccupants} onChange={e=>upd('additionalOccupants',e.target.value)} placeholder="John Doe Jr. (minor), Jane Doe Jr. (minor)"/></div>
                                    <p className="form-hint">List dependents, minors, or other occupants who will not sign the lease.</p>
                                </div>
                            </>}

                            {step === 2 && <>
                                <div className="form-section">
                                    <h3 className="form-section-title">PROPERTY ADDRESS</h3>
                                    <div className="form-grid">
                                        <div className="form-group full-width"><label>Street Address *</label><input value={form.propertyAddress} onChange={e=>upd('propertyAddress',e.target.value)} placeholder="237 Majestic Cedar Dr"/></div>
                                        <div className="form-group"><label>City *</label><input value={form.propertyCity} onChange={e=>upd('propertyCity',e.target.value)} placeholder="Round Rock"/></div>
                                        <div className="form-group"><label>ZIP Code *</label><input value={form.propertyZip} onChange={e=>upd('propertyZip',e.target.value)} placeholder="78665"/></div>
                                        <div className="form-group"><label>County *</label><input value={form.propertyCounty} onChange={e=>upd('propertyCounty',e.target.value)} placeholder="Williamson"/></div>
                                        <div className="form-group full-width"><label>Legal Description (Lot, Block, Subdivision)</label><input value={form.legalDescription} onChange={e=>upd('legalDescription',e.target.value)} placeholder="LOT 6, BLOCK OO, SIENA SEC 14, WILLIAMSON COUNTY, TEXAS"/></div>
                                    </div>
                                </div>
                                <div className="form-section">
                                    <h3 className="form-section-title">PROPERTY DETAILS</h3>
                                    <div className="form-grid">
                                        <div className="form-group">
                                            <label>Property Type</label>
                                            <select value={form.propertyType} onChange={e=>upd('propertyType',e.target.value)}>
                                                <option value="single-family">Single Family Home</option>
                                                <option value="condo">Condominium</option>
                                                <option value="townhouse">Townhouse</option>
                                                <option value="apartment">Apartment</option>
                                                <option value="duplex">Duplex</option>
                                            </select>
                                        </div>
                                        <div className="form-group"><label>Bedrooms</label><input type="number" value={form.bedrooms} onChange={e=>upd('bedrooms',e.target.value)} placeholder="3"/></div>
                                        <div className="form-group"><label>Bathrooms</label><input type="number" step="0.5" value={form.bathrooms} onChange={e=>upd('bathrooms',e.target.value)} placeholder="2.5"/></div>
                                        <div className="form-group"><label>Square Feet</label><input type="number" value={form.squareFeet} onChange={e=>upd('squareFeet',e.target.value)} placeholder="2400"/></div>
                                        <div className="form-group"><label>Parking Spaces</label><input type="number" value={form.parkingSpaces} onChange={e=>upd('parkingSpaces',e.target.value)} placeholder="2"/></div>
                                        <div className="form-group"><label>HOA Name (if applicable)</label><input value={form.hoaName} onChange={e=>upd('hoaName',e.target.value)} placeholder="Siena Homeowners Association"/></div>
                                    </div>
                                </div>
                            </>}

                            {step === 3 && <>
                                <div className="form-section">
                                    <h3 className="form-section-title">LEASE TERM</h3>
                                    <div className="form-grid">
                                        <div className="form-group"><label>Lease Start Date (Commencement) *</label><input type="date" value={form.commencementDate} onChange={e=>upd('commencementDate',e.target.value)}/></div>
                                        <div className="form-group"><label>Lease End Date (Expiration) *</label><input type="date" value={form.expirationDate} onChange={e=>upd('expirationDate',e.target.value)}/></div>
                                        <div className="form-group"><label>Termination Notice (days)</label><input type="number" value={form.terminationNoticeDays} onChange={e=>upd('terminationNoticeDays',e.target.value)} placeholder="30"/><p className="form-hint">Days notice required before lease end</p></div>
                                        <div className="form-group"><label>Access Notice (hours)</label><input type="number" value={form.accessNoticeHours} onChange={e=>upd('accessNoticeHours',e.target.value)} placeholder="24"/><p className="form-hint">Notice before landlord entry</p></div>
                                    </div>
                                </div>
                                <div className="alert alert-info" style={{marginTop:'1rem'}}><span className="alert-icon">‚ÑπÔ∏è</span><div>Per Texas Property Code, lease automatically renews month-to-month unless either party provides written notice of termination.</div></div>
                            </>}

                            {step === 4 && <>
                                <div className="form-section">
                                    <h3 className="form-section-title">RENT</h3>
                                    <div className="form-grid">
                                        <div className="form-group"><label>Monthly Rent *</label><div style={{position:'relative'}}><span style={{position:'absolute',left:'12px',top:'50%',transform:'translateY(-50%)',color:'var(--gray-500)'}}>$</span><input type="number" value={form.monthlyRent} onChange={e=>upd('monthlyRent',e.target.value)} placeholder="2,300" style={{paddingLeft:'28px'}}/></div></div>
                                        <div className="form-group"><label>Security Deposit *</label><div style={{position:'relative'}}><span style={{position:'absolute',left:'12px',top:'50%',transform:'translateY(-50%)',color:'var(--gray-500)'}}>$</span><input type="number" value={form.securityDeposit} onChange={e=>upd('securityDeposit',e.target.value)} placeholder="2,300" style={{paddingLeft:'28px'}}/></div></div>
                                        <div className="form-group"><label>Prorated Rent (first month, if any)</label><div style={{position:'relative'}}><span style={{position:'absolute',left:'12px',top:'50%',transform:'translateY(-50%)',color:'var(--gray-500)'}}>$</span><input type="number" value={form.proratedRent} onChange={e=>upd('proratedRent',e.target.value)} placeholder="0" style={{paddingLeft:'28px'}}/></div></div>
                                        <div className="form-group"><label>Prorated Rent Due Date</label><input type="date" value={form.proratedDueDate} onChange={e=>upd('proratedDueDate',e.target.value)}/></div>
                                    </div>
                                </div>
                                <div className="form-section">
                                    <h3 className="form-section-title">LATE FEES</h3>
                                    <div className="form-grid">
                                        <div className="form-group"><label>Grace Period</label><div style={{display:'flex',alignItems:'center',gap:'8px'}}><input type="number" value={form.gracePeriodDay} onChange={e=>upd('gracePeriodDay',e.target.value)} style={{width:'80px'}}/><span>day(s) of month</span></div></div>
                                        <div className="form-group"><label>Initial Late Fee</label><div style={{position:'relative'}}><span style={{position:'absolute',left:'12px',top:'50%',transform:'translateY(-50%)',color:'var(--gray-500)'}}>$</span><input type="number" value={form.initialLateFee} onChange={e=>upd('initialLateFee',e.target.value)} placeholder="50" style={{paddingLeft:'28px'}}/></div></div>
                                        <div className="form-group"><label>Daily Late Fee</label><div style={{position:'relative'}}><span style={{position:'absolute',left:'12px',top:'50%',transform:'translateY(-50%)',color:'var(--gray-500)'}}>$</span><input type="number" value={form.dailyLateFee} onChange={e=>upd('dailyLateFee',e.target.value)} placeholder="25" style={{paddingLeft:'28px'}}/></div></div>
                                        <div className="form-group"><label>Returned Payment Fee</label><div style={{position:'relative'}}><span style={{position:'absolute',left:'12px',top:'50%',transform:'translateY(-50%)',color:'var(--gray-500)'}}>$</span><input type="number" value={form.returnedPaymentFee} onChange={e=>upd('returnedPaymentFee',e.target.value)} placeholder="75" style={{paddingLeft:'28px'}}/></div></div>
                                    </div>
                                    <p className="form-hint">Per Texas Property Code ¬ß92.019, late fees must be reasonable.</p>
                                </div>
                                <div className="form-section">
                                    <h3 className="form-section-title">PAYMENT INFORMATION</h3>
                                    <div className="form-grid">
                                        <div className="form-group"><label>Make Payments To</label><input value={form.paymentName} onChange={e=>upd('paymentName',e.target.value)} placeholder={form.landlordName || 'Landlord Name'}/></div>
                                        <div className="form-group"><label>Payment Address</label><input value={form.paymentAddress} onChange={e=>upd('paymentAddress',e.target.value)} placeholder="123 Main St, Austin, TX 78701"/></div>
                                    </div>
                                    <div style={{marginTop:'1rem'}}>
                                        <label style={{display:'block',marginBottom:'0.5rem',fontWeight:500}}>Accepted Payment Methods</label>
                                        <div style={{display:'flex',flexWrap:'wrap',gap:'1rem'}}>
                                            <Checkbox checked={form.paymentMethods.includes('check')} onChange={()=>upd('paymentMethods',toggleArray(form.paymentMethods,'check'))} label="Personal Check"/>
                                            <Checkbox checked={form.paymentMethods.includes('cashiers')} onChange={()=>upd('paymentMethods',toggleArray(form.paymentMethods,'cashiers'))} label="Cashier's Check"/>
                                            <Checkbox checked={form.paymentMethods.includes('money-order')} onChange={()=>upd('paymentMethods',toggleArray(form.paymentMethods,'money-order'))} label="Money Order"/>
                                            <Checkbox checked={form.paymentMethods.includes('electronic')} onChange={()=>upd('paymentMethods',toggleArray(form.paymentMethods,'electronic'))} label="Electronic Payment"/>
                                        </div>
                                    </div>
                                </div>
                            </>}

                            {step === 5 && <>
                                <div className="form-section">
                                    <h3 className="form-section-title">PET POLICY</h3>
                                    <div style={{marginBottom:'1rem'}}>
                                        <Checkbox checked={form.petsAllowed} onChange={()=>upd('petsAllowed',!form.petsAllowed)} label="Pets are allowed on the property"/>
                                    </div>
                                    {form.petsAllowed && <div className="form-grid">
                                        <div className="form-group full-width"><label>Allowed Pets (describe type, breed, weight limits)</label><input value={form.allowedPets} onChange={e=>upd('allowedPets',e.target.value)} placeholder="Up to 2 dogs under 50 lbs each, no aggressive breeds"/></div>
                                        <div className="form-group"><label>Pet Deposit</label><div style={{position:'relative'}}><span style={{position:'absolute',left:'12px',top:'50%',transform:'translateY(-50%)',color:'var(--gray-500)'}}>$</span><input type="number" value={form.petDeposit} onChange={e=>upd('petDeposit',e.target.value)} placeholder="500" style={{paddingLeft:'28px'}}/></div></div>
                                        <div className="form-group"><label>Monthly Pet Rent</label><div style={{position:'relative'}}><span style={{position:'absolute',left:'12px',top:'50%',transform:'translateY(-50%)',color:'var(--gray-500)'}}>$</span><input type="number" value={form.petRent} onChange={e=>upd('petRent',e.target.value)} placeholder="25" style={{paddingLeft:'28px'}}/></div></div>
                                    </div>}
                                </div>
                                <div className="form-section">
                                    <h3 className="form-section-title">SMOKING POLICY</h3>
                                    <Checkbox checked={form.smokingAllowed} onChange={()=>upd('smokingAllowed',!form.smokingAllowed)} label="Smoking is permitted on the property"/>
                                    {!form.smokingAllowed && <p className="form-hint" style={{marginTop:'0.5rem'}}>Smoking is prohibited inside the property and within 25 feet of any entrance.</p>}
                                </div>
                                <div className="form-section">
                                    <h3 className="form-section-title">UTILITIES</h3>
                                    <div style={{marginBottom:'1rem'}}>
                                        <label style={{display:'block',marginBottom:'0.5rem',fontWeight:500}}>Tenant Pays:</label>
                                        <div style={{display:'flex',flexWrap:'wrap',gap:'1rem'}}>
                                            <Checkbox checked={form.utilitiesTenant.includes('electric')} onChange={()=>upd('utilitiesTenant',toggleArray(form.utilitiesTenant,'electric'))} label="Electric"/>
                                            <Checkbox checked={form.utilitiesTenant.includes('gas')} onChange={()=>upd('utilitiesTenant',toggleArray(form.utilitiesTenant,'gas'))} label="Gas"/>
                                            <Checkbox checked={form.utilitiesTenant.includes('water')} onChange={()=>upd('utilitiesTenant',toggleArray(form.utilitiesTenant,'water'))} label="Water/Sewer"/>
                                            <Checkbox checked={form.utilitiesTenant.includes('trash')} onChange={()=>upd('utilitiesTenant',toggleArray(form.utilitiesTenant,'trash'))} label="Trash"/>
                                            <Checkbox checked={form.utilitiesTenant.includes('internet')} onChange={()=>upd('utilitiesTenant',toggleArray(form.utilitiesTenant,'internet'))} label="Internet/Cable"/>
                                            <Checkbox checked={form.utilitiesTenant.includes('lawn')} onChange={()=>upd('utilitiesTenant',toggleArray(form.utilitiesTenant,'lawn'))} label="Lawn Care"/>
                                        </div>
                                    </div>
                                    <div>
                                        <label style={{display:'block',marginBottom:'0.5rem',fontWeight:500}}>Landlord Pays:</label>
                                        <div style={{display:'flex',flexWrap:'wrap',gap:'1rem'}}>
                                            <Checkbox checked={form.utilitiesLandlord.includes('hoa')} onChange={()=>upd('utilitiesLandlord',toggleArray(form.utilitiesLandlord,'hoa'))} label="HOA Fees"/>
                                            <Checkbox checked={form.utilitiesLandlord.includes('water')} onChange={()=>upd('utilitiesLandlord',toggleArray(form.utilitiesLandlord,'water'))} label="Water/Sewer"/>
                                            <Checkbox checked={form.utilitiesLandlord.includes('trash')} onChange={()=>upd('utilitiesLandlord',toggleArray(form.utilitiesLandlord,'trash'))} label="Trash"/>
                                            <Checkbox checked={form.utilitiesLandlord.includes('lawn')} onChange={()=>upd('utilitiesLandlord',toggleArray(form.utilitiesLandlord,'lawn'))} label="Lawn Care"/>
                                        </div>
                                    </div>
                                </div>
                            </>}

                            {step === 6 && <>
                                <div className="form-section">
                                    <h3 className="form-section-title">SPECIAL PROVISIONS</h3>
                                    <div className="form-group full-width">
                                        <label>Additional Terms and Conditions</label>
                                        <textarea rows={6} value={form.specialProvisions} onChange={e=>upd('specialProvisions',e.target.value)} placeholder="Enter any additional terms, conditions, or special agreements between the parties..."/>
                                        <p className="form-hint">Examples: move-in cleaning requirements, specific maintenance responsibilities, appliance warranties, etc.</p>
                                    </div>
                                </div>
                                <div className="alert alert-warning"><span className="alert-icon">‚ö†Ô∏è</span><div><strong>Important Notice</strong><br/>This lease will be governed by Texas Property Code and all applicable local ordinances. Both parties are encouraged to review the complete document before signing.</div></div>
                            </>}
                        </div>
                        <div className="modal-footer">
                            {step > 1 && <button className="btn btn-secondary" onClick={() => setStep(step - 1)}>Previous</button>}
                            <div style={{flex:1}}/>
                            <span style={{color:'var(--gray-500)',fontSize:'0.875rem'}}>Step {step} of 6</span>
                            <div style={{flex:1}}/>
                            {step < 6 ? <button className="btn btn-primary" onClick={() => setStep(step + 1)}>Next</button>
                                      : <button className="btn btn-primary" onClick={submit}>{isEditing ? 'Save Changes' : 'Create Lease'}</button>}
                        </div>
                    </div>
                </div>
            );
        }

        // Confirm Modal
        function ConfirmModal({ title, message, confirmText, confirmStyle, onClose, onConfirm }) {
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal modal-sm" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">{title}</h2>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        <div className="modal-body">
                            <p style={{color:'var(--gray-600)'}}>{message}</p>
                        </div>
                        <div className="modal-footer">
                            <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
                            <button className={`btn btn-${confirmStyle || 'primary'}`} onClick={onConfirm}>{confirmText || 'Confirm'}</button>
                        </div>
                    </div>
                </div>
            );
        }

        // Send Modal
        function SendModal({ doc, onClose, onSend }) {
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Send for Signature</h2>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        <div className="modal-body">
                            <p style={{color:'var(--gray-600)',marginBottom:'1.5rem'}}>Send this lease for electronic signature. Both parties will receive an email with instructions.</p>
                            <div style={{background:'var(--gray-50)',borderRadius:'8px',padding:'1rem',marginBottom:'1rem'}}>
                                <div style={{fontWeight:600,marginBottom:'0.75rem'}}>Signing Order:</div>
                                <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'0.5rem'}}>
                                    <span style={{width:'24px',height:'24px',background:'var(--primary)',color:'white',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'0.75rem',fontWeight:600}}>1</span>
                                    <span><strong>Landlord</strong> ({doc.landlordEmail})</span>
                                </div>
                                <div style={{display:'flex',alignItems:'center',gap:'0.75rem'}}>
                                    <span style={{width:'24px',height:'24px',background:'var(--gray-300)',color:'white',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'0.75rem',fontWeight:600}}>2</span>
                                    <span><strong>Tenant</strong> ({doc.tenantEmail})</span>
                                </div>
                            </div>
                            <div className="alert alert-info"><span className="alert-icon">üìß</span><div><strong>Email Notification</strong><br/><span style={{fontSize:'0.875rem'}}>A signing link will be sent to {doc.landlordEmail}</span></div></div>
                        </div>
                        <div className="modal-footer">
                            <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
                            <button className="btn btn-primary" onClick={onSend}><Icon name="send" size={16}/> Send Now</button>
                        </div>
                    </div>
                </div>
            );
        }

        // Save Template Modal
        function SaveTemplateModal({ doc, onClose, onSave }) {
            const [name, setName] = useState(`Template - ${doc.propertyAddress || 'New'}`);
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal modal-sm" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Save as Template</h2>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        <div className="modal-body">
                            <div className="form-group">
                                <label>Template Name</label>
                                <input value={name} onChange={e => setName(e.target.value)} />
                            </div>
                            <p style={{fontSize:'0.875rem',color:'var(--gray-500)',marginTop:'1rem'}}>Templates save all lease terms except tenant information and signatures.</p>
                        </div>
                        <div className="modal-footer">
                            <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
                            <button className="btn btn-primary" onClick={() => onSave(name)}>Save Template</button>
                        </div>
                    </div>
                </div>
            );
        }

        // Document Detail
        function DocDetail({ doc, onBack, onSend, onDownload, onDelete, onRefresh, onDuplicate, onVoid, onResend, onSaveTemplate, onEdit, toast }) {
            const [tab, setTab] = useState('preview');
            const [audit, setAudit] = useState([]);
            const [menuOpen, setMenuOpen] = useState(false);

            useEffect(() => {
                api.get(`/documents/${doc.id}/audit`).then(setAudit).catch(() => {});
            }, [doc.id]);

            const field = v => v || '____________';

            const canSend = doc.status === 'draft';
            const canEdit = doc.status === 'draft';
            const canResend = doc.status === 'pending' || doc.status === 'partial';
            const canVoid = doc.status !== 'completed' && doc.status !== 'voided';
            const canDownload = doc.status === 'completed';

            return <>
                <div className="page-header">
                    <div>
                        <button className="btn btn-secondary btn-sm" style={{marginBottom:'1rem'}} onClick={onBack}><Icon name="back" size={16}/> Back</button>
                        <h1 className="page-title">{doc.title || 'Untitled'}</h1>
                        <p className="page-subtitle">{doc.propertyAddress}</p>
                    </div>
                    <div className="action-bar">
                        {canEdit && <button className="btn btn-secondary" onClick={onEdit}><Icon name="edit" size={16}/> Edit</button>}
                        {canSend && <button className="btn btn-primary" onClick={onSend}><Icon name="send" size={16}/> Send for Signature</button>}
                        {canResend && <button className="btn btn-warning" onClick={onResend}><Icon name="refresh" size={16}/> Send Reminder</button>}
                        {canDownload && <button className="btn btn-success" onClick={onDownload}><Icon name="download" size={16}/> Download PDF</button>}

                        <div className="dropdown">
                            <button className="btn btn-secondary btn-icon" onClick={() => setMenuOpen(!menuOpen)}><Icon name="more" size={20}/></button>
                            {menuOpen && <div className="dropdown-menu show">
                                <div className="dropdown-item" onClick={() => { setMenuOpen(false); onDuplicate(); }}><Icon name="copy" size={16}/> Duplicate</div>
                                <div className="dropdown-item" onClick={() => { setMenuOpen(false); onSaveTemplate(); }}><Icon name="template" size={16}/> Save as Template</div>
                                <div className="dropdown-divider"/>
                                {canVoid && <div className="dropdown-item danger" onClick={() => { setMenuOpen(false); onVoid(); }}><Icon name="ban" size={16}/> Void Document</div>}
                                {doc.status === 'draft' && <div className="dropdown-item danger" onClick={() => { setMenuOpen(false); onDelete(); }}><Icon name="trash" size={16}/> Delete</div>}
                            </div>}
                        </div>
                    </div>
                </div>

                <div className="detail-grid">
                    <div className="card">
                        <div className="card-header"><span className="card-title">Document</span><StatusBadge status={doc.status}/></div>
                        <div className="card-body">
                            <div className="tabs">
                                <div className={`tab ${tab==='preview'?'active':''}`} onClick={()=>setTab('preview')}>Preview</div>
                                <div className={`tab ${tab==='details'?'active':''}`} onClick={()=>setTab('details')}>Details</div>
                                <div className={`tab ${tab==='audit'?'active':''}`} onClick={()=>setTab('audit')}>Audit Log</div>
                            </div>

                            {tab === 'preview' && <div className="doc-preview" style={{maxHeight:'600px'}}>
                                <div style={{borderBottom:'2px solid #000',paddingBottom:'1rem',marginBottom:'1rem'}}>
                                    <h1 style={{marginBottom:'0.25rem'}}>RESIDENTIAL LEASE AGREEMENT</h1>
                                    <p className="subtitle">Texas Residential Lease Agreement</p>
                                </div>

                                <div className="section"><p className="section-title">1. PARTIES TO THIS LEASE</p>
                                    <p>This Residential Lease Agreement ("Lease") is entered into between:</p>
                                    <p style={{marginLeft:'1rem'}}><strong>LANDLORD:</strong> <span className="field">{field(doc.landlordName)}</span></p>
                                    <p style={{marginLeft:'1rem'}}><strong>TENANT(S):</strong> <span className="field">{field(doc.tenantName)}</span>{doc.additionalOccupants && <>, and {doc.additionalOccupants}</>}</p>
                                </div>

                                <div className="section"><p className="section-title">2. LEASED PREMISES</p>
                                    <p>Landlord leases to Tenant the real property and improvements described below (collectively referred to as the "Property"):</p>
                                    <p style={{marginLeft:'1rem'}}><strong>Address:</strong> <span className="field">{field(doc.propertyAddress)}</span></p>
                                    <p style={{marginLeft:'1rem'}}><strong>City/State/ZIP:</strong> <span className="field">{field(doc.propertyCity)}, Texas {doc.propertyZip}</span></p>
                                    <p style={{marginLeft:'1rem'}}><strong>County:</strong> <span className="field">{field(doc.propertyCounty)}</span></p>
                                    {doc.legalDescription && <p style={{marginLeft:'1rem'}}><strong>Legal Description:</strong> <span className="field">{doc.legalDescription}</span></p>}
                                    {(doc.bedrooms || doc.bathrooms || doc.squareFeet) && <p style={{marginLeft:'1rem'}}><strong>Property Details:</strong> {doc.bedrooms && `${doc.bedrooms} Bedrooms`}{doc.bathrooms && `, ${doc.bathrooms} Bathrooms`}{doc.squareFeet && `, ${doc.squareFeet} sq ft`}</p>}
                                </div>

                                <div className="section"><p className="section-title">3. LEASE TERM</p>
                                    <p style={{marginLeft:'1rem'}}><strong>Commencement Date:</strong> <span className="field">{field(doc.commencementDate)}</span></p>
                                    <p style={{marginLeft:'1rem'}}><strong>Expiration Date:</strong> <span className="field">{field(doc.expirationDate)}</span> at 11:59 p.m.</p>
                                    <p style={{marginTop:'0.5rem',fontSize:'9pt',fontStyle:'italic'}}>This lease automatically renews on a month-to-month basis unless either party provides {doc.terminationNoticeDays || 30} days written notice of termination.</p>
                                </div>

                                <div className="section"><p className="section-title">4. RENT</p>
                                    <p style={{marginLeft:'1rem'}}><strong>Monthly Rent:</strong> <span className="field">${field(doc.monthlyRent)}</span> due on or before the 1st day of each month</p>
                                    {doc.proratedRent && <p style={{marginLeft:'1rem'}}><strong>Prorated Rent:</strong> ${doc.proratedRent} due on {doc.proratedDueDate}</p>}
                                    <p style={{marginLeft:'1rem'}}><strong>Payment To:</strong> <span className="field">{field(doc.paymentName || doc.landlordName)}</span></p>
                                    {doc.paymentAddress && <p style={{marginLeft:'1rem'}}><strong>Payment Address:</strong> {doc.paymentAddress}</p>}
                                </div>

                                <div className="section"><p className="section-title">5. LATE CHARGES</p>
                                    <p>If rent is not received by the {doc.gracePeriodDay || 3}rd day of the month at 11:59 p.m., Tenant shall pay:</p>
                                    <p style={{marginLeft:'1rem'}}>‚Ä¢ Initial late charge: <span className="field">${doc.initialLateFee || 50}</span></p>
                                    <p style={{marginLeft:'1rem'}}>‚Ä¢ Additional daily charge: <span className="field">${doc.dailyLateFee || 25}</span> per day until paid in full</p>
                                    <p style={{marginLeft:'1rem'}}>‚Ä¢ Returned payment fee: <span className="field">${doc.returnedPaymentFee || 75}</span></p>
                                </div>

                                <div className="section"><p className="section-title">6. SECURITY DEPOSIT</p>
                                    <p style={{marginLeft:'1rem'}}><strong>Amount:</strong> <span className="field">${field(doc.securityDeposit)}</span></p>
                                    <p style={{marginTop:'0.5rem',fontSize:'9pt'}}>Security deposit will be returned within 30 days after Tenant surrenders the Property, less any lawful deductions for unpaid rent, damages beyond normal wear and tear, and other charges permitted by Texas Property Code ¬ß92.103-92.109.</p>
                                </div>

                                <div className="section"><p className="section-title">7. UTILITIES</p>
                                    {doc.utilitiesTenant?.length > 0 && <p style={{marginLeft:'1rem'}}><strong>Tenant pays:</strong> {doc.utilitiesTenant.join(', ')}</p>}
                                    {doc.utilitiesLandlord?.length > 0 && <p style={{marginLeft:'1rem'}}><strong>Landlord pays:</strong> {doc.utilitiesLandlord.join(', ')}</p>}
                                    {!doc.utilitiesTenant?.length && !doc.utilitiesLandlord?.length && <p style={{marginLeft:'1rem'}}>Tenant pays all utilities.</p>}
                                </div>

                                <div className="section"><p className="section-title">8. ANIMALS</p>
                                    <p style={{marginLeft:'1rem'}}>{doc.petsAllowed ? <>Pets are <strong>PERMITTED</strong> subject to: {doc.allowedPets || 'landlord approval'}{doc.petDeposit && `. Pet deposit: $${doc.petDeposit}`}{doc.petRent && `. Monthly pet rent: $${doc.petRent}`}</> : <>Pets are <strong>NOT PERMITTED</strong> without prior written consent of Landlord.</>}</p>
                                </div>

                                <div className="section"><p className="section-title">9. SMOKING</p>
                                    <p style={{marginLeft:'1rem'}}>Smoking is <strong>{doc.smokingAllowed ? 'PERMITTED' : 'PROHIBITED'}</strong> {!doc.smokingAllowed && 'inside the Property and within 25 feet of any entrance'}.</p>
                                </div>

                                <div className="section"><p className="section-title">10. ACCESS BY LANDLORD</p>
                                    <p style={{marginLeft:'1rem'}}>Landlord may enter the Property at reasonable times with {doc.accessNoticeHours || 24} hours advance notice, except in emergencies.</p>
                                </div>

                                {doc.hoaName && <div className="section"><p className="section-title">11. HOMEOWNERS ASSOCIATION</p>
                                    <p style={{marginLeft:'1rem'}}>Property is subject to: <span className="field">{doc.hoaName}</span>. Tenant agrees to comply with all HOA rules and regulations.</p>
                                </div>}

                                {doc.specialProvisions && <div className="section"><p className="section-title">SPECIAL PROVISIONS</p><p style={{marginLeft:'1rem',whiteSpace:'pre-wrap'}}>{doc.specialProvisions}</p></div>}

                                <div className="section" style={{marginTop:'1.5rem',borderTop:'1px solid #ccc',paddingTop:'1rem'}}>
                                    <p className="section-title">AGREEMENT</p>
                                    <p style={{fontSize:'9pt'}}>This Lease is the entire agreement between Landlord and Tenant. No oral agreements have been made. This Lease is binding upon and inures to the benefit of the parties and their respective heirs, executors, administrators, successors, and permitted assigns. This Lease shall be governed by and construed in accordance with the laws of the State of Texas.</p>
                                </div>

                                <div className="section" style={{marginTop:'2rem',borderTop:'2px solid #000',paddingTop:'1rem'}}>
                                    <p className="section-title" style={{textAlign:'center',fontSize:'12pt'}}>EXECUTION</p>
                                    <p style={{textAlign:'center',fontSize:'9pt',marginBottom:'1.5rem'}}>By signing below, each party acknowledges reading and understanding this Lease and agrees to be bound by its terms.</p>
                                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'2rem',marginTop:'1rem'}}>
                                        <div style={{borderRight:'1px solid #ccc',paddingRight:'1rem'}}>
                                            <p><strong>LANDLORD:</strong></p>
                                            {doc.landlordSignature ? <>
                                                <img src={doc.landlordSignature} className="signature-image" alt="Landlord Signature" style={{maxHeight:'60px',marginTop:'0.5rem'}}/>
                                                <p style={{fontSize:'8pt',color:'#666',marginTop:'0.25rem'}}>Electronically signed: {new Date(doc.landlordSignedAt).toLocaleString()}</p>
                                                <p style={{fontSize:'8pt',color:'#666'}}>IP: {doc.landlordSignedIp}</p>
                                            </> : <div style={{height:'60px',borderBottom:'1px solid #000',marginTop:'0.5rem'}}/>}
                                            <p style={{marginTop:'0.5rem'}}>{doc.landlordName}</p>
                                            {doc.landlordEmail && <p style={{fontSize:'8pt',color:'#666'}}>{doc.landlordEmail}</p>}
                                        </div>
                                        <div>
                                            <p><strong>TENANT:</strong></p>
                                            {doc.tenantSignature ? <>
                                                <img src={doc.tenantSignature} className="signature-image" alt="Tenant Signature" style={{maxHeight:'60px',marginTop:'0.5rem'}}/>
                                                <p style={{fontSize:'8pt',color:'#666',marginTop:'0.25rem'}}>Electronically signed: {new Date(doc.tenantSignedAt).toLocaleString()}</p>
                                                <p style={{fontSize:'8pt',color:'#666'}}>IP: {doc.tenantSignedIp}</p>
                                            </> : <div style={{height:'60px',borderBottom:'1px solid #000',marginTop:'0.5rem'}}/>}
                                            <p style={{marginTop:'0.5rem'}}>{doc.tenantName}</p>
                                            {doc.tenantEmail && <p style={{fontSize:'8pt',color:'#666'}}>{doc.tenantEmail}</p>}
                                        </div>
                                    </div>
                                </div>

                                <div style={{marginTop:'2rem',padding:'1rem',background:'#f5f5f5',borderRadius:'4px',fontSize:'8pt',textAlign:'center',color:'#666'}}>
                                    <strong>CERTIFICATE OF ELECTRONIC SIGNING</strong><br/>
                                    This document was signed electronically via LeaseSign. Electronic signatures are legally binding under the ESIGN Act (15 U.S.C. ¬ß 7001) and UETA.<br/>
                                    Document ID: {doc.id}<br/>
                                    Status: {doc.status === 'completed' ? 'FULLY EXECUTED' : 'PENDING SIGNATURES'}
                                </div>
                            </div>}

                            {tab === 'details' && <div>
                                <div style={{marginBottom:'1.5rem'}}>
                                    <h4 style={{color:'var(--gray-500)',fontSize:'0.75rem',fontWeight:600,textTransform:'uppercase',letterSpacing:'0.05em',marginBottom:'0.75rem',borderBottom:'1px solid var(--gray-200)',paddingBottom:'0.5rem'}}>Parties</h4>
                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',gap:'0.75rem'}}>
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Landlord</span><br/><strong>{doc.landlordName}</strong></div>
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Landlord Email</span><br/>{doc.landlordEmail}</div>
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Landlord Phone</span><br/>{doc.landlordPhone || 'N/A'}</div>
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Tenant</span><br/><strong>{doc.tenantName}</strong></div>
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Tenant Email</span><br/>{doc.tenantEmail}</div>
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Tenant Phone</span><br/>{doc.tenantPhone || 'N/A'}</div>
                                        {doc.additionalOccupants && <div style={{gridColumn:'1/-1'}}><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Additional Occupants</span><br/>{doc.additionalOccupants}</div>}
                                    </div>
                                </div>
                                <div style={{marginBottom:'1.5rem'}}>
                                    <h4 style={{color:'var(--gray-500)',fontSize:'0.75rem',fontWeight:600,textTransform:'uppercase',letterSpacing:'0.05em',marginBottom:'0.75rem',borderBottom:'1px solid var(--gray-200)',paddingBottom:'0.5rem'}}>Property</h4>
                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',gap:'0.75rem'}}>
                                        <div style={{gridColumn:'1/-1'}}><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Address</span><br/><strong>{doc.propertyAddress}</strong></div>
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>City/State</span><br/>{doc.propertyCity}, TX {doc.propertyZip}</div>
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>County</span><br/>{doc.propertyCounty}</div>
                                        {doc.propertyType && <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Property Type</span><br/>{doc.propertyType}</div>}
                                        {doc.bedrooms && <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Bedrooms</span><br/>{doc.bedrooms}</div>}
                                        {doc.bathrooms && <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Bathrooms</span><br/>{doc.bathrooms}</div>}
                                        {doc.squareFeet && <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Square Feet</span><br/>{doc.squareFeet}</div>}
                                        {doc.legalDescription && <div style={{gridColumn:'1/-1'}}><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Legal Description</span><br/>{doc.legalDescription}</div>}
                                    </div>
                                </div>
                                <div style={{marginBottom:'1.5rem'}}>
                                    <h4 style={{color:'var(--gray-500)',fontSize:'0.75rem',fontWeight:600,textTransform:'uppercase',letterSpacing:'0.05em',marginBottom:'0.75rem',borderBottom:'1px solid var(--gray-200)',paddingBottom:'0.5rem'}}>Lease Terms</h4>
                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',gap:'0.75rem'}}>
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Start Date</span><br/><strong>{doc.commencementDate}</strong></div>
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>End Date</span><br/><strong>{doc.expirationDate}</strong></div>
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Termination Notice</span><br/>{doc.terminationNoticeDays || 30} days</div>
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Access Notice</span><br/>{doc.accessNoticeHours || 24} hours</div>
                                    </div>
                                </div>
                                <div style={{marginBottom:'1.5rem'}}>
                                    <h4 style={{color:'var(--gray-500)',fontSize:'0.75rem',fontWeight:600,textTransform:'uppercase',letterSpacing:'0.05em',marginBottom:'0.75rem',borderBottom:'1px solid var(--gray-200)',paddingBottom:'0.5rem'}}>Financial Terms</h4>
                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(150px, 1fr))',gap:'0.75rem'}}>
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Monthly Rent</span><br/><strong style={{fontSize:'1.25rem',color:'var(--primary)'}}>${doc.monthlyRent}</strong></div>
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Security Deposit</span><br/><strong>${doc.securityDeposit}</strong></div>
                                        {doc.proratedRent && <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Prorated Rent</span><br/>${doc.proratedRent}</div>}
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Grace Period</span><br/>Day {doc.gracePeriodDay || 3}</div>
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Initial Late Fee</span><br/>${doc.initialLateFee || 50}</div>
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Daily Late Fee</span><br/>${doc.dailyLateFee || 25}</div>
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Returned Payment Fee</span><br/>${doc.returnedPaymentFee || 75}</div>
                                    </div>
                                </div>
                                <div>
                                    <h4 style={{color:'var(--gray-500)',fontSize:'0.75rem',fontWeight:600,textTransform:'uppercase',letterSpacing:'0.05em',marginBottom:'0.75rem',borderBottom:'1px solid var(--gray-200)',paddingBottom:'0.5rem'}}>Rules & Policies</h4>
                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',gap:'0.75rem'}}>
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Pets</span><br/>{doc.petsAllowed ? `Allowed: ${doc.allowedPets || 'With approval'}` : 'Not Allowed'}</div>
                                        <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Smoking</span><br/>{doc.smokingAllowed ? 'Permitted' : 'Not Permitted'}</div>
                                        {doc.utilitiesTenant?.length > 0 && <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>Tenant Pays</span><br/>{doc.utilitiesTenant.join(', ')}</div>}
                                        {doc.hoaName && <div><span style={{color:'var(--gray-500)',fontSize:'0.8rem'}}>HOA</span><br/>{doc.hoaName}</div>}
                                    </div>
                                </div>
                            </div>}

                            {tab === 'audit' && <div>
                                {audit.length === 0 ? <p style={{color:'var(--gray-500)'}}>No audit events yet.</p> :
                                audit.map((a, i) => <div key={i} style={{padding:'0.75rem 0',borderBottom:'1px solid var(--gray-100)'}}>
                                    <div style={{fontWeight:500}}>{a.action.replace(/_/g, ' ')}</div>
                                    <div style={{fontSize:'0.875rem',color:'var(--gray-500)'}}>{a.actor} ‚Ä¢ {new Date(a.timestamp).toLocaleString()} ‚Ä¢ IP: {a.ip}</div>
                                </div>)}
                            </div>}
                        </div>
                    </div>

                    <div>
                        <div className="card" style={{marginBottom:'1.5rem'}}>
                            <div className="card-header"><span className="card-title">Signature Status</span></div>
                            <div className="card-body">
                                <div className="timeline">
                                    <div className="timeline-item">
                                        <div className={`timeline-dot ${doc.landlordSignedAt ? 'success' : doc.status !== 'draft' ? 'pending' : ''}`}>{doc.landlordSignedAt ? '‚úì' : '1'}</div>
                                        <div className="timeline-content">
                                            <div className="timeline-title">Landlord</div>
                                            <div className="timeline-meta">{doc.landlordSignedAt ? `Signed ${new Date(doc.landlordSignedAt).toLocaleString()}` : doc.status === 'draft' ? 'Not sent' : 'Pending'}</div>
                                        </div>
                                    </div>
                                    <div className="timeline-item">
                                        <div className={`timeline-dot ${doc.tenantSignedAt ? 'success' : ''}`}>{doc.tenantSignedAt ? '‚úì' : '2'}</div>
                                        <div className="timeline-content">
                                            <div className="timeline-title">Tenant</div>
                                            <div className="timeline-meta">{doc.tenantSignedAt ? `Signed ${new Date(doc.tenantSignedAt).toLocaleString()}` : doc.tenantEmail}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="card">
                            <div className="card-header"><span className="card-title">Info</span></div>
                            <div className="card-body">
                                <div style={{marginBottom:'1rem'}}><div style={{fontSize:'0.875rem',color:'var(--gray-500)'}}>Created</div><div style={{fontWeight:500}}>{new Date(doc.createdAt).toLocaleDateString()}</div></div>
                                <div style={{marginBottom:'1rem'}}><div style={{fontSize:'0.875rem',color:'var(--gray-500)'}}>Updated</div><div style={{fontWeight:500}}>{new Date(doc.updatedAt).toLocaleDateString()}</div></div>
                                <div><div style={{fontSize:'0.875rem',color:'var(--gray-500)'}}>ID</div><div style={{fontWeight:500,fontSize:'0.65rem',fontFamily:'monospace',wordBreak:'break-all'}}>{doc.id}</div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </>;
        }

        // Simple Bar Chart Component
        function BarChart({ data, height = 120 }) {
            const max = Math.max(...data.map(d => d.value), 1);
            return (
                <div style={{display:'flex',alignItems:'flex-end',gap:'8px',height,padding:'0.5rem 0'}}>
                    {data.map((d, i) => (
                        <div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center'}}>
                            <div style={{width:'100%',maxWidth:'40px',background:d.color||'var(--primary)',borderRadius:'4px 4px 0 0',height:`${(d.value/max)*100}%`,minHeight:d.value>0?'4px':'0',transition:'height 0.3s ease'}}/>
                            <div style={{fontSize:'0.7rem',color:'var(--gray-500)',marginTop:'4px',textAlign:'center'}}>{d.label}</div>
                            <div style={{fontSize:'0.75rem',fontWeight:600}}>{d.value}</div>
                        </div>
                    ))}
                </div>
            );
        }

        // Dashboard
        function Dashboard({ user, onLogout }) {
            const [view, setView] = useState('dashboard');
            const [docs, setDocs] = useState([]);
            const [templates, setTemplates] = useState([]);
            const [stats, setStats] = useState({});
            const [doc, setDoc] = useState(null);
            const [showCreate, setShowCreate] = useState(false);
            const [showEdit, setShowEdit] = useState(false);
            const [showSend, setShowSend] = useState(false);
            const [showVoid, setShowVoid] = useState(false);
            const [showDelete, setShowDelete] = useState(false);
            const [showSaveTemplate, setShowSaveTemplate] = useState(false);
            const [selectedTemplate, setSelectedTemplate] = useState(null);
            const [toasts, setToasts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [menuOpen, setMenuOpen] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');

            useEffect(() => { loadData(); }, []);

            const loadData = async () => {
                try {
                    const [docsData, statsData, templatesData] = await Promise.all([
                        api.get('/documents'),
                        api.get('/stats'),
                        api.get('/templates')
                    ]);
                    setDocs(docsData.filter(d => !d.isTemplate));
                    setStats(statsData);
                    setTemplates(templatesData);
                } catch (e) { toast(e.message, 'error'); }
                finally { setLoading(false); }
            };

            const toast = (message, type = 'success') => { 
                const id = Date.now(); 
                setToasts(t => [...t, { id, message, type }]); 
                setTimeout(() => setToasts(t => t.filter(x => x.id !== id)), 4000); 
            };

            const createDoc = async (data) => {
                try {
                    let d;
                    if (selectedTemplate) {
                        d = await api.post(`/templates/${selectedTemplate.id}/use`, data);
                    } else {
                        d = await api.post('/documents', data);
                    }
                    setDocs([d, ...docs]);
                    setShowCreate(false);
                    setSelectedTemplate(null);
                    toast('Lease created!');
                    setDoc(d);
                    setView('detail');
                } catch (e) { toast(e.message, 'error'); }
            };

            const updateDoc = async (data) => {
                try {
                    const d = await api.put(`/documents/${doc.id}`, data);
                    setDocs(docs.map(x => x.id === d.id ? d : x));
                    setDoc(d);
                    setShowEdit(false);
                    toast('Lease updated!');
                } catch (e) { toast(e.message, 'error'); }
            };

            const sendDoc = async () => { 
                try { 
                    const d = await api.post(`/documents/${doc.id}/send`); 
                    setDocs(docs.map(x => x.id === d.id ? d : x)); 
                    setDoc(d); 
                    setShowSend(false); 
                    toast('Sent for signature!'); 
                } catch (e) { toast(e.message, 'error'); } 
            };
            
            const resendDoc = async () => {
                try {
                    const result = await api.post(`/documents/${doc.id}/resend`);
                    toast(`Reminder sent to ${result.sentTo}`);
                } catch (e) { toast(e.message, 'error'); }
            };
            
            const duplicateDoc = async () => {
                try {
                    const d = await api.post(`/documents/${doc.id}/duplicate`);
                    setDocs([d, ...docs]);
                    toast('Document duplicated!');
                    setDoc(d);
                } catch (e) { toast(e.message, 'error'); }
            };
            
            const voidDoc = async () => {
                try {
                    const d = await api.post(`/documents/${doc.id}/void`, { reason: 'Voided by user' });
                    setDocs(docs.map(x => x.id === d.id ? d : x));
                    setDoc(d);
                    setShowVoid(false);
                    toast('Document voided');
                } catch (e) { toast(e.message, 'error'); }
            };
            
            const deleteDoc = async () => { 
                try { 
                    await api.del(`/documents/${doc.id}`); 
                    setDocs(docs.filter(x => x.id !== doc.id)); 
                    setDoc(null); 
                    setView('dashboard');
                    setShowDelete(false);
                    toast('Deleted'); 
                } catch (e) { toast(e.message, 'error'); } 
            };
            
            const saveAsTemplate = async (name) => {
                try {
                    const t = await api.post('/templates', { documentId: doc.id, name });
                    setTemplates([t, ...templates]);
                    setShowSaveTemplate(false);
                    toast('Template saved!');
                } catch (e) { toast(e.message, 'error'); }
            };
            
            const downloadPdf = () => window.open(`/api/documents/${doc.id}/pdf`, '_blank');

            const activeDocs = docs.filter(d => d.status !== 'voided');

            // Filter documents based on search and status
            const filteredDocs = activeDocs.filter(d => {
                const matchesSearch = !searchQuery ||
                    (d.title || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
                    (d.propertyAddress || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
                    (d.tenantName || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
                    (d.tenantEmail || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
                    (d.propertyCity || '').toLowerCase().includes(searchQuery.toLowerCase());
                const matchesStatus = statusFilter === 'all' || d.status === statusFilter;
                return matchesSearch && matchesStatus;
            });

            return <div>
                <nav className="top-nav">
                    <div className="logo" onClick={() => { setView('dashboard'); setDoc(null); }}><div className="logo-icon">üìù</div>LeaseSign</div>
                    <div className="user-menu">
                        <button className="user-btn" onClick={() => setMenuOpen(!menuOpen)}>
                            <div className="user-avatar">{user.name?.charAt(0).toUpperCase()}</div>
                            <span style={{fontWeight:500}}>{user.name}</span>
                        </button>
                        {menuOpen && <div className="user-dropdown">
                            <button className="user-dropdown-item danger" onClick={() => { api.setToken(null); onLogout(); }}><Icon name="logout" size={16}/> Sign Out</button>
                        </div>}
                    </div>
                </nav>

                <div className="app-layout">
                    <aside className="sidebar">
                        <div className="sidebar-label">Menu</div>
                        <div className={`sidebar-item ${view==='dashboard'&&!doc?'active':''}`} onClick={() => { setView('dashboard'); setDoc(null); }}><Icon name="home"/> Dashboard</div>
                        <div className={`sidebar-item ${view==='documents'?'active':''}`} onClick={() => { setView('documents'); setDoc(null); }}><Icon name="folder"/> All Documents {activeDocs.length > 0 && <span className="sidebar-badge">{activeDocs.length}</span>}</div>
                        <div className={`sidebar-item ${view==='templates'?'active':''}`} onClick={() => { setView('templates'); setDoc(null); }}><Icon name="template"/> Templates {templates.length > 0 && <span className="sidebar-badge">{templates.length}</span>}</div>
                        <div className="sidebar-label">Actions</div>
                        <div className="sidebar-item" onClick={() => { setSelectedTemplate(null); setShowCreate(true); }}><Icon name="plus"/> New Lease</div>
                    </aside>

                    <main className="main-content">
                        {view === 'detail' && doc ? (
                            <DocDetail
                                doc={doc}
                                onBack={() => { setView('dashboard'); setDoc(null); }}
                                onSend={() => setShowSend(true)}
                                onDownload={downloadPdf}
                                onDelete={() => setShowDelete(true)}
                                onDuplicate={duplicateDoc}
                                onVoid={() => setShowVoid(true)}
                                onResend={resendDoc}
                                onSaveTemplate={() => setShowSaveTemplate(true)}
                                onEdit={() => setShowEdit(true)}
                                toast={toast}
                            />
                        ) : view === 'templates' ? (
                            <>
                                <div className="page-header">
                                    <div><h1 className="page-title">Templates</h1><p className="page-subtitle">Reusable lease templates</p></div>
                                </div>
                                <div className="card">
                                    <div className="card-header"><span className="card-title">My Templates</span></div>
                                    {templates.length === 0 ? (
                                        <div className="empty-state">
                                            <div className="empty-state-icon">üìã</div>
                                            <h3>No templates yet</h3>
                                            <p>Save a document as a template to reuse it</p>
                                        </div>
                                    ) : (
                                        <div className="doc-list">
                                            {templates.map(t => (
                                                <div key={t.id} className="doc-item" onClick={() => { setSelectedTemplate(t); setShowCreate(true); }}>
                                                    <div className="doc-icon template">üìã</div>
                                                    <div className="doc-info">
                                                        <div className="doc-title">{t.templateName || 'Untitled Template'}</div>
                                                        <div className="doc-meta">{t.propertyAddress || 'No address'} ‚Ä¢ {new Date(t.createdAt).toLocaleDateString()}</div>
                                                    </div>
                                                    <button className="btn btn-primary btn-sm">Use Template</button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </>
                        ) : (
                            <>
                                <div className="page-header">
                                    <div><h1 className="page-title">{view === 'documents' ? 'All Documents' : 'Dashboard'}</h1><p className="page-subtitle">Manage your lease documents</p></div>
                                    <button className="btn btn-primary btn-lg" onClick={() => { setSelectedTemplate(null); setShowCreate(true); }}><Icon name="plus" size={18}/> New Lease</button>
                                </div>

                                {view === 'dashboard' && <>
                                    <div className="stats-grid">
                                        <div className="stat-card"><div className="stat-icon blue">üìÑ</div><div className="stat-label">Total</div><div className="stat-value">{stats.total || 0}</div></div>
                                        <div className="stat-card"><div className="stat-icon yellow">‚è≥</div><div className="stat-label">Awaiting</div><div className="stat-value">{(stats.pending || 0) + (stats.partial || 0)}</div></div>
                                        <div className="stat-card"><div className="stat-icon green">‚úì</div><div className="stat-label">Completed</div><div className="stat-value">{stats.completed || 0}</div></div>
                                        <div className="stat-card"><div className="stat-icon gray">üìù</div><div className="stat-label">Drafts</div><div className="stat-value">{stats.draft || 0}</div></div>
                                        <div className="stat-card"><div className="stat-icon purple">üìã</div><div className="stat-label">Templates</div><div className="stat-value">{templates.length}</div></div>
                                        <div className="stat-card"><div className="stat-icon red">üö´</div><div className="stat-label">Voided</div><div className="stat-value">{stats.voided || 0}</div></div>
                                    </div>
                                    <div className="card" style={{marginBottom:'1.5rem'}}>
                                        <div className="card-header"><span className="card-title"><Icon name="chart" size={16}/> Document Status Overview</span></div>
                                        <div className="card-body">
                                            <BarChart data={[
                                                { label: 'Draft', value: stats.draft || 0, color: 'var(--gray-400)' },
                                                { label: 'Pending', value: stats.pending || 0, color: 'var(--warning)' },
                                                { label: 'Partial', value: stats.partial || 0, color: '#f59e0b' },
                                                { label: 'Completed', value: stats.completed || 0, color: 'var(--success)' },
                                                { label: 'Voided', value: stats.voided || 0, color: 'var(--danger)' }
                                            ]} />
                                        </div>
                                    </div>
                                </>}

                                {view === 'documents' && <div className="card" style={{marginBottom:'1rem'}}>
                                    <div className="card-body" style={{padding:'1rem'}}>
                                        <div style={{display:'flex',gap:'1rem',flexWrap:'wrap',alignItems:'center'}}>
                                            <div style={{flex:'1',minWidth:'200px',position:'relative'}}>
                                                <Icon name="search" size={16} style={{position:'absolute',left:'12px',top:'50%',transform:'translateY(-50%)',color:'var(--gray-400)'}}/>
                                                <input
                                                    type="text"
                                                    placeholder="Search by address, tenant, title..."
                                                    value={searchQuery}
                                                    onChange={e => setSearchQuery(e.target.value)}
                                                    style={{paddingLeft:'36px',width:'100%'}}
                                                />
                                            </div>
                                            <select value={statusFilter} onChange={e => setStatusFilter(e.target.value)} style={{minWidth:'150px'}}>
                                                <option value="all">All Status</option>
                                                <option value="draft">Draft</option>
                                                <option value="pending">Pending</option>
                                                <option value="partial">Partially Signed</option>
                                                <option value="completed">Completed</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>}

                                <div className="card">
                                    <div className="card-header"><span className="card-title">{view === 'documents' ? `Documents (${filteredDocs.length})` : 'Recent Documents'}</span></div>
                                    {loading ? <div className="card-body" style={{textAlign:'center',padding:'3rem'}}>Loading...</div>
                                    : (view === 'documents' ? filteredDocs : activeDocs).length === 0 ? <div className="empty-state"><div className="empty-state-icon">üìÑ</div><h3>{view === 'documents' && (searchQuery || statusFilter !== 'all') ? 'No matching documents' : 'No documents yet'}</h3><p>{view === 'documents' && (searchQuery || statusFilter !== 'all') ? 'Try adjusting your search or filters' : 'Create your first lease document'}</p>{!searchQuery && statusFilter === 'all' && <button className="btn btn-primary" onClick={() => { setSelectedTemplate(null); setShowCreate(true); }}><Icon name="plus" size={16}/> Create Lease</button>}</div>
                                    : <div className="doc-list">{(view === 'documents' ? filteredDocs : activeDocs.slice(0, 10)).map(d => (
                                        <div key={d.id} className="doc-item" onClick={() => { setDoc(d); setView('detail'); }}>
                                            <div className="doc-icon">üìã</div>
                                            <div className="doc-info"><div className="doc-title">{d.title || 'Untitled'}</div><div className="doc-meta">{d.tenantName || 'No tenant'} ‚Ä¢ {d.propertyAddress || 'No address'} ‚Ä¢ {new Date(d.createdAt).toLocaleDateString()}</div></div>
                                            <StatusBadge status={d.status}/>
                                        </div>
                                    ))}</div>}
                                </div>
                            </>
                        )}
                    </main>
                </div>

                {showCreate && <CreateModal onClose={() => { setShowCreate(false); setSelectedTemplate(null); }} onCreate={createDoc} user={user} template={selectedTemplate}/>}
                {showEdit && doc && <CreateModal onClose={() => setShowEdit(false)} onUpdate={updateDoc} user={user} editDoc={doc}/>}
                {showSend && doc && <SendModal doc={doc} onClose={() => setShowSend(false)} onSend={sendDoc}/>}
                {showVoid && <ConfirmModal title="Void Document" message="Are you sure you want to void this document? This action cannot be undone. The signing links will no longer work." confirmText="Void Document" confirmStyle="danger" onClose={() => setShowVoid(false)} onConfirm={voidDoc}/>}
                {showDelete && <ConfirmModal title="Delete Document" message="Are you sure you want to delete this document? This action cannot be undone." confirmText="Delete" confirmStyle="danger" onClose={() => setShowDelete(false)} onConfirm={deleteDoc}/>}
                {showSaveTemplate && doc && <SaveTemplateModal doc={doc} onClose={() => setShowSaveTemplate(false)} onSave={saveAsTemplate}/>}
                <Toasts toasts={toasts} remove={id => setToasts(t => t.filter(x => x.id !== id))}/>
            </div>;
        }

        // Public Signing Page
        function SigningPage({ token }) {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [signing, setSigning] = useState(false);
            const [done, setDone] = useState(false);
            const [agreed, setAgreed] = useState(false);

            useEffect(() => {
                fetch(`/api/sign/${token}`).then(r => r.json()).then(d => { if (d.error) throw new Error(d.error); setData(d); }).catch(e => setError(e.message)).finally(() => setLoading(false));
            }, [token]);

            const submit = async (sig) => {
                if (!agreed) { alert('Please agree to the terms before signing.'); return; }
                setSigning(true);
                try {
                    const res = await fetch(`/api/sign/${token}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ signature: sig }) });
                    const d = await res.json();
                    if (!res.ok) throw new Error(d.error);
                    setDone(true);
                } catch (e) { setError(e.message); }
                finally { setSigning(false); }
            };

            if (loading) return <div className="auth-container"><div className="auth-card" style={{textAlign:'center'}}><div style={{fontSize:'2rem',marginBottom:'1rem'}}>‚è≥</div><h2>Loading Document...</h2><p style={{color:'var(--gray-500)'}}>Please wait while we retrieve your lease agreement.</p></div></div>;
            if (error) return <div className="auth-container"><div className="auth-card" style={{textAlign:'center'}}><div style={{fontSize:'3rem',marginBottom:'1rem'}}>‚ö†Ô∏è</div><h2>Error</h2><p style={{color:'var(--gray-500)'}}>{error}</p><p style={{color:'var(--gray-400)',fontSize:'0.875rem',marginTop:'1rem'}}>If you believe this is an error, please contact the sender.</p></div></div>;
            if (done) return <div className="auth-container"><div className="auth-card" style={{textAlign:'center'}}><div style={{fontSize:'3rem',marginBottom:'1rem'}}>‚úÖ</div><h2>Document Signed Successfully!</h2><p style={{color:'var(--gray-500)',marginBottom:'1rem'}}>Thank you for signing. You will receive a copy of the fully executed lease via email once all parties have signed.</p><div style={{background:'var(--gray-50)',padding:'1rem',borderRadius:'8px',fontSize:'0.875rem',color:'var(--gray-600)'}}><strong>What happens next?</strong><br/>The other party will be notified to sign. Once complete, all parties will receive the final executed document.</div></div></div>;

            const { document: doc, signerType } = data;
            const signerName = signerType === 'landlord' ? doc.landlordName : doc.tenantName;
            const signerEmail = signerType === 'landlord' ? doc.landlordEmail : doc.tenantEmail;
            const field = v => v || '____________';

            return <div style={{background:'var(--gray-100)',minHeight:'100vh'}}>
                <nav className="top-nav">
                    <div className="logo"><div className="logo-icon">üìù</div>LeaseSign</div>
                    <div style={{display:'flex',alignItems:'center',gap:'1rem'}}>
                        <span style={{color:'var(--gray-500)',fontSize:'0.875rem'}}>Signing as:</span>
                        <span style={{fontWeight:600}}>{signerName}</span>
                    </div>
                </nav>
                <div className="signing-container" style={{maxWidth:'1000px'}}>
                    <div className="signing-header" style={{display:'flex',justifyContent:'space-between',alignItems:'center',flexWrap:'wrap',gap:'1rem'}}>
                        <div>
                            <h2 style={{fontFamily:"'DM Sans',sans-serif",fontWeight:700,marginBottom:'0.25rem'}}>Residential Lease Agreement</h2>
                            <p style={{color:'var(--gray-500)'}}>{doc.propertyAddress}, {doc.propertyCity}, TX {doc.propertyZip}</p>
                        </div>
                        <div style={{textAlign:'right'}}>
                            <span className="status-badge status-pending"><span className="status-dot"></span>Action Required</span>
                        </div>
                    </div>

                    <div className="alert alert-info" style={{marginBottom:'1.5rem'}}>
                        <span className="alert-icon">‚ÑπÔ∏è</span>
                        <div>
                            <strong>Please review this document carefully</strong><br/>
                            Scroll through the entire lease agreement below, then sign at the bottom to confirm your agreement.
                        </div>
                    </div>

                    <div className="card" style={{marginBottom:'1.5rem'}}>
                        <div className="card-header" style={{background:'var(--gray-50)'}}>
                            <span className="card-title">RESIDENTIAL LEASE AGREEMENT - COMPLETE DOCUMENT</span>
                        </div>
                        <div className="card-body" style={{padding:0}}>
                            <div className="doc-preview" style={{maxHeight:'500px',margin:0,border:'none',borderRadius:0}}>
                                <div style={{borderBottom:'2px solid #000',paddingBottom:'1rem',marginBottom:'1rem'}}>
                                    <h1 style={{marginBottom:'0.25rem'}}>RESIDENTIAL LEASE AGREEMENT</h1>
                                    <p className="subtitle">Texas Residential Lease Agreement</p>
                                </div>

                                <div className="section"><p className="section-title">1. PARTIES TO THIS LEASE</p>
                                    <p>This Residential Lease Agreement ("Lease") is entered into between:</p>
                                    <p style={{marginLeft:'1rem'}}><strong>LANDLORD:</strong> <span className="field">{field(doc.landlordName)}</span></p>
                                    <p style={{marginLeft:'1rem'}}><strong>TENANT(S):</strong> <span className="field">{field(doc.tenantName)}</span>{doc.additionalOccupants && <>, and {doc.additionalOccupants}</>}</p>
                                </div>

                                <div className="section"><p className="section-title">2. LEASED PREMISES</p>
                                    <p>Landlord leases to Tenant the real property and all improvements located at:</p>
                                    <p style={{marginLeft:'1rem'}}><strong>Address:</strong> <span className="field">{field(doc.propertyAddress)}</span></p>
                                    <p style={{marginLeft:'1rem'}}><strong>City/State/ZIP:</strong> <span className="field">{field(doc.propertyCity)}, Texas {doc.propertyZip}</span></p>
                                    <p style={{marginLeft:'1rem'}}><strong>County:</strong> <span className="field">{field(doc.propertyCounty)}</span></p>
                                    {doc.legalDescription && <p style={{marginLeft:'1rem'}}><strong>Legal Description:</strong> <span className="field">{doc.legalDescription}</span></p>}
                                    {(doc.bedrooms || doc.bathrooms) && <p style={{marginLeft:'1rem'}}><strong>Property:</strong> {doc.bedrooms && `${doc.bedrooms} Bed`}{doc.bathrooms && ` / ${doc.bathrooms} Bath`}{doc.squareFeet && ` / ${doc.squareFeet} sq ft`}</p>}
                                </div>

                                <div className="section"><p className="section-title">3. LEASE TERM</p>
                                    <p style={{marginLeft:'1rem'}}><strong>Commencement Date:</strong> <span className="field">{field(doc.commencementDate)}</span></p>
                                    <p style={{marginLeft:'1rem'}}><strong>Expiration Date:</strong> <span className="field">{field(doc.expirationDate)}</span> at 11:59 p.m.</p>
                                    <p style={{marginTop:'0.5rem',fontSize:'9pt'}}>This lease automatically renews on a month-to-month basis unless either party provides {doc.terminationNoticeDays || 30} days written notice of termination before the Expiration Date.</p>
                                </div>

                                <div className="section"><p className="section-title">4. RENT AND PAYMENTS</p>
                                    <p style={{marginLeft:'1rem'}}><strong>Monthly Rent:</strong> <span className="field">${field(doc.monthlyRent)}</span> due on or before the 1st day of each month</p>
                                    {doc.proratedRent && <p style={{marginLeft:'1rem'}}><strong>Prorated Rent:</strong> ${doc.proratedRent} due on {doc.proratedDueDate}</p>}
                                    <p style={{marginLeft:'1rem'}}><strong>Make Payments To:</strong> <span className="field">{field(doc.paymentName || doc.landlordName)}</span></p>
                                    {doc.paymentAddress && <p style={{marginLeft:'1rem'}}><strong>Payment Address:</strong> {doc.paymentAddress}</p>}
                                </div>

                                <div className="section"><p className="section-title">5. LATE CHARGES</p>
                                    <p>If rent is not received by the {doc.gracePeriodDay || 3}rd day of the month at 11:59 p.m., Tenant shall pay:</p>
                                    <p style={{marginLeft:'1rem'}}>‚Ä¢ Initial late charge: <span className="field">${doc.initialLateFee || 50}</span></p>
                                    <p style={{marginLeft:'1rem'}}>‚Ä¢ Additional daily charge: <span className="field">${doc.dailyLateFee || 25}</span> per day until paid</p>
                                    <p style={{marginLeft:'1rem'}}>‚Ä¢ Returned payment fee: <span className="field">${doc.returnedPaymentFee || 75}</span> per occurrence</p>
                                </div>

                                <div className="section"><p className="section-title">6. SECURITY DEPOSIT</p>
                                    <p style={{marginLeft:'1rem'}}><strong>Amount:</strong> <span className="field">${field(doc.securityDeposit)}</span></p>
                                    <p style={{fontSize:'9pt',marginTop:'0.5rem'}}>Security deposit will be returned within 30 days after Tenant surrenders the Property in accordance with this Lease, less any lawful deductions for: unpaid rent, late fees, unpaid utilities, cost of repairs beyond normal wear and tear, cleaning, key replacement, and other charges permitted under Texas Property Code ¬ß92.103-92.109.</p>
                                </div>

                                <div className="section"><p className="section-title">7. UTILITIES</p>
                                    {doc.utilitiesTenant?.length > 0 && <p style={{marginLeft:'1rem'}}><strong>Tenant Pays:</strong> {doc.utilitiesTenant.map(u => u.charAt(0).toUpperCase() + u.slice(1)).join(', ')}</p>}
                                    {doc.utilitiesLandlord?.length > 0 && <p style={{marginLeft:'1rem'}}><strong>Landlord Pays:</strong> {doc.utilitiesLandlord.map(u => u.charAt(0).toUpperCase() + u.slice(1)).join(', ')}</p>}
                                    {!doc.utilitiesTenant?.length && !doc.utilitiesLandlord?.length && <p style={{marginLeft:'1rem'}}>Tenant shall pay all utilities.</p>}
                                </div>

                                <div className="section"><p className="section-title">8. ANIMALS</p>
                                    <p style={{marginLeft:'1rem'}}>{doc.petsAllowed ? <>Pets <strong>ARE PERMITTED</strong> subject to: {doc.allowedPets || 'prior landlord approval'}.{doc.petDeposit && ` Pet deposit: $${doc.petDeposit}.`}{doc.petRent && ` Monthly pet rent: $${doc.petRent}.`}</> : <>Pets <strong>ARE NOT PERMITTED</strong> without prior written consent of Landlord. Unauthorized animals may result in lease termination and/or additional charges.</>}</p>
                                </div>

                                <div className="section"><p className="section-title">9. SMOKING</p>
                                    <p style={{marginLeft:'1rem'}}>Smoking is <strong>{doc.smokingAllowed ? 'PERMITTED' : 'STRICTLY PROHIBITED'}</strong> {!doc.smokingAllowed && 'inside the Property and within 25 feet of any entrance, window, or ventilation system'}.</p>
                                </div>

                                <div className="section"><p className="section-title">10. PARKING</p>
                                    <p style={{marginLeft:'1rem'}}>Maximum of {doc.parkingSpaces || 4} vehicles permitted. All vehicles must be operable with current registration. No commercial vehicles, trailers, boats, or recreational vehicles without prior written consent.</p>
                                </div>

                                <div className="section"><p className="section-title">11. ACCESS BY LANDLORD</p>
                                    <p style={{marginLeft:'1rem'}}>Landlord may enter the Property at reasonable times with {doc.accessNoticeHours || 24} hours advance notice for: inspections, repairs, showings to prospective tenants or buyers, or any other lawful purpose. In case of emergency, Landlord may enter without notice.</p>
                                </div>

                                {doc.hoaName && <div className="section"><p className="section-title">12. HOMEOWNERS ASSOCIATION</p>
                                    <p style={{marginLeft:'1rem'}}>The Property is subject to <span className="field">{doc.hoaName}</span>. Tenant agrees to comply with all HOA rules, regulations, and CC&Rs. Violations may result in fines which will be Tenant's responsibility.</p>
                                </div>}

                                <div className="section"><p className="section-title">13. MAINTENANCE AND REPAIRS</p>
                                    <p style={{marginLeft:'1rem'}}>Tenant shall keep the Property clean and sanitary, dispose of garbage properly, and promptly notify Landlord of any needed repairs or dangerous conditions. Tenant is responsible for repairs caused by Tenant, occupants, or guests.</p>
                                </div>

                                <div className="section"><p className="section-title">14. DEFAULT AND REMEDIES</p>
                                    <p style={{fontSize:'9pt'}}>Tenant default includes: nonpayment of rent, abandonment, material lease violations, or false statements in rental application. Upon default, Landlord may terminate this Lease, accelerate all remaining rent, pursue eviction, and seek damages and attorney's fees.</p>
                                </div>

                                {doc.specialProvisions && <div className="section"><p className="section-title">SPECIAL PROVISIONS</p><p style={{marginLeft:'1rem',whiteSpace:'pre-wrap'}}>{doc.specialProvisions}</p></div>}

                                <div className="section" style={{marginTop:'1.5rem',padding:'1rem',background:'#f9f9f9',border:'1px solid #ddd'}}>
                                    <p className="section-title">AGREEMENT OF PARTIES</p>
                                    <p style={{fontSize:'9pt'}}>This Lease constitutes the entire agreement between the parties. No oral agreements or representations have been made. This Lease is binding upon and inures to the benefit of the parties and their respective heirs, executors, administrators, successors, and permitted assigns. All parties signing this Lease are jointly and severally liable for all obligations hereunder. This Lease shall be governed by and construed in accordance with the laws of the State of Texas.</p>
                                </div>

                                <div style={{marginTop:'1.5rem',textAlign:'center',fontSize:'8pt',color:'#666'}}>
                                    <p>Electronic signatures are legally binding under the ESIGN Act (15 U.S.C. ¬ß 7001) and Texas UETA.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="card">
                        <div className="card-header" style={{background:'var(--primary-50)'}}>
                            <span className="card-title" style={{color:'var(--primary)'}}>Sign Document</span>
                        </div>
                        <div className="card-body">
                            <div style={{background:'var(--gray-50)',padding:'1rem',borderRadius:'8px',marginBottom:'1.5rem'}}>
                                <p style={{fontWeight:600,marginBottom:'0.5rem'}}>You are signing as: {signerType === 'landlord' ? 'LANDLORD' : 'TENANT'}</p>
                                <p style={{fontSize:'0.875rem',color:'var(--gray-600)'}}>Name: {signerName}<br/>Email: {signerEmail}</p>
                            </div>

                            <div style={{marginBottom:'1.5rem'}}>
                                <label style={{display:'flex',alignItems:'flex-start',gap:'0.75rem',cursor:'pointer',padding:'1rem',border:'1px solid var(--gray-300)',borderRadius:'8px',background:agreed?'var(--success-light)':'white'}}>
                                    <input type="checkbox" checked={agreed} onChange={()=>setAgreed(!agreed)} style={{width:'20px',height:'20px',marginTop:'2px',accentColor:'var(--success)'}}/>
                                    <span style={{fontSize:'0.9rem'}}>
                                        <strong>I have read and agree to the terms of this Residential Lease Agreement.</strong><br/>
                                        <span style={{color:'var(--gray-600)',fontSize:'0.8rem'}}>I understand that by signing below, I am entering into a legally binding contract. I confirm that all information provided is accurate and that I have had the opportunity to review this document in its entirety.</span>
                                    </span>
                                </label>
                            </div>

                            {agreed ? <SignaturePad signerName={signerName} onComplete={submit}/> :
                                <div style={{textAlign:'center',padding:'2rem',background:'var(--gray-50)',borderRadius:'8px',border:'2px dashed var(--gray-300)'}}>
                                    <p style={{color:'var(--gray-500)'}}>Please check the box above to confirm you have read and agree to the lease terms before signing.</p>
                                </div>
                            }
                            {signing && <p style={{textAlign:'center',color:'var(--gray-500)',marginTop:'1rem'}}>Submitting your signature...</p>}
                        </div>
                    </div>

                    <div style={{textAlign:'center',padding:'2rem',color:'var(--gray-500)',fontSize:'0.8rem'}}>
                        <p>Powered by LeaseSign | Secure Electronic Signatures</p>
                        <p>Questions? Contact the document sender or visit our help center.</p>
                    </div>
                </div>
            </div>;
        }

        // App
        function App() {
            const [user, setUser] = useState(null);
            const [authView, setAuthView] = useState('login');
            const [loading, setLoading] = useState(true);

            const signToken = window.location.pathname.match(/^\/sign\/(.+)$/)?.[1];

            useEffect(() => {
                if (signToken) { setLoading(false); return; }
                const token = localStorage.getItem('leasesign_token');
                if (token) {
                    api.token = token;
                    api.get('/auth/me').then(setUser).catch(() => localStorage.removeItem('leasesign_token')).finally(() => setLoading(false));
                } else { setLoading(false); }
            }, []);

            if (loading) return <div className="auth-container"><div>Loading...</div></div>;
            if (signToken) return <SigningPage token={signToken}/>;
            if (!user) return authView === 'register' ? <RegisterPage onRegister={setUser} onSwitch={() => setAuthView('login')}/> : <LoginPage onLogin={setUser} onSwitch={() => setAuthView('register')}/>;
            return <Dashboard user={user} onLogout={() => setUser(null)}/>;
        }

        ReactDOM.render(<App/>, document.getElementById('root'));
    </script>
</body>
</html>
