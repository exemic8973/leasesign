<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeaseSign - Texas Residential Lease E-Signature Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5; --primary-dark: #4338ca; --primary-light: #818cf8; --primary-50: #eef2ff;
            --success: #10b981; --success-light: #d1fae5;
            --warning: #f59e0b; --warning-light: #fef3c7;
            --danger: #ef4444; --danger-light: #fee2e2;
            --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb; --gray-300: #d1d5db;
            --gray-400: #9ca3af; --gray-500: #6b7280; --gray-600: #4b5563; --gray-700: #374151;
            --gray-800: #1f2937; --gray-900: #111827;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--gray-50); color: var(--gray-800); min-height: 100vh; }
        
        .top-nav { background: white; border-bottom: 1px solid var(--gray-200); padding: 0 2rem; height: 64px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .logo { display: flex; align-items: center; gap: 0.75rem; font-family: 'DM Sans', sans-serif; font-weight: 700; font-size: 1.5rem; color: var(--primary); cursor: pointer; }
        .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem; }
        
        .app-layout { display: flex; min-height: calc(100vh - 64px); }
        .sidebar { width: 260px; background: white; border-right: 1px solid var(--gray-200); padding: 1.5rem 0; flex-shrink: 0; }
        .sidebar-label { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-400); padding: 0 1.5rem; margin: 1.5rem 0 0.5rem; }
        .sidebar-label:first-child { margin-top: 0; }
        .sidebar-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1.5rem; color: var(--gray-600); cursor: pointer; transition: all 0.15s; border-left: 3px solid transparent; font-size: 0.9375rem; }
        .sidebar-item:hover { background: var(--gray-50); color: var(--gray-800); }
        .sidebar-item.active { background: var(--primary-50); color: var(--primary); border-left-color: var(--primary); font-weight: 500; }
        .sidebar-item svg { width: 20px; height: 20px; flex-shrink: 0; }
        .sidebar-badge { margin-left: auto; background: var(--primary); color: white; font-size: 0.7rem; font-weight: 600; padding: 0.125rem 0.5rem; border-radius: 9999px; min-width: 20px; text-align: center; }
        .main-content { flex: 1; padding: 2rem; overflow-y: auto; max-width: 1200px; }
        
        .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        .page-title { font-family: 'DM Sans', sans-serif; font-size: 1.75rem; font-weight: 700; color: var(--gray-900); }
        .page-subtitle { color: var(--gray-500); margin-top: 0.25rem; }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.625rem 1.25rem; font-size: 0.875rem; font-weight: 500; border-radius: 8px; border: none; cursor: pointer; transition: all 0.15s; font-family: inherit; text-decoration: none; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--primary-dark); }
        .btn-secondary { background: white; color: var(--gray-700); border: 1px solid var(--gray-300); }
        .btn-secondary:hover:not(:disabled) { background: var(--gray-50); border-color: var(--gray-400); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover:not(:disabled) { background: #059669; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover:not(:disabled) { background: #d97706; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover:not(:disabled) { background: #dc2626; }
        .btn-ghost { background: transparent; color: var(--gray-600); }
        .btn-ghost:hover:not(:disabled) { background: var(--gray-100); }
        .btn-lg { padding: 0.875rem 1.75rem; font-size: 1rem; }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8125rem; }
        .btn-icon { padding: 0.5rem; }
        
        .card { background: white; border-radius: 12px; border: 1px solid var(--gray-200); overflow: hidden; }
        .card-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--gray-100); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .card-title { font-weight: 600; color: var(--gray-900); }
        .card-body { padding: 1.5rem; }
        
        .status-badge { display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 500; border-radius: 9999px; }
        .status-draft { background: var(--gray-100); color: var(--gray-600); }
        .status-pending { background: var(--warning-light); color: #92400e; }
        .status-partial { background: #dbeafe; color: #1e40af; }
        .status-completed { background: var(--success-light); color: #065f46; }
        .status-voided { background: var(--danger-light); color: #991b1b; }
        .status-template { background: #e0e7ff; color: #3730a3; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
        
        .doc-list { display: flex; flex-direction: column; }
        .doc-item { display: flex; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--gray-100); cursor: pointer; transition: background 0.15s; gap: 1rem; }
        .doc-item:hover { background: var(--gray-50); }
        .doc-item:last-child { border-bottom: none; }
        .doc-icon { width: 48px; height: 48px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
        .doc-icon.template { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); }
        .doc-info { flex: 1; min-width: 0; }
        .doc-title { font-weight: 600; color: var(--gray-900); margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .doc-meta { font-size: 0.875rem; color: var(--gray-500); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: white; border-radius: 12px; border: 1px solid var(--gray-200); padding: 1.25rem; }
        .stat-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; margin-bottom: 0.75rem; }
        .stat-icon.blue { background: #dbeafe; }
        .stat-icon.yellow { background: #fef3c7; }
        .stat-icon.green { background: #d1fae5; }
        .stat-icon.red { background: #fee2e2; }
        .stat-icon.gray { background: var(--gray-100); }
        .stat-icon.purple { background: #e0e7ff; }
        .stat-label { font-size: 0.8rem; color: var(--gray-500); margin-bottom: 0.125rem; }
        .stat-value { font-family: 'DM Sans', sans-serif; font-size: 1.75rem; font-weight: 700; color: var(--gray-900); }
        
        .form-section { margin-bottom: 2rem; }
        .form-section-title { font-weight: 600; color: var(--gray-900); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--gray-200); display: flex; align-items: center; gap: 0.5rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        .form-group { margin-bottom: 0; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.375rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.625rem 0.875rem; font-size: 0.9375rem; border: 1px solid var(--gray-300); border-radius: 8px; transition: all 0.15s; font-family: inherit; background: white; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .form-group input:disabled { background: var(--gray-100); }
        .form-hint { font-size: 0.8rem; color: var(--gray-500); margin-top: 0.25rem; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal { background: white; border-radius: 16px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-lg { max-width: 900px; }
        .modal-sm { max-width: 450px; }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; z-index: 1; }
        .modal-title { font-family: 'DM Sans', sans-serif; font-size: 1.25rem; font-weight: 700; }
        .modal-close { width: 36px; height: 36px; border-radius: 8px; border: none; background: var(--gray-100); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; color: var(--gray-500); }
        .modal-close:hover { background: var(--gray-200); }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1.5rem; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 0.75rem; position: sticky; bottom: 0; background: white; }
        
        .tabs { display: flex; border-bottom: 1px solid var(--gray-200); margin-bottom: 1.5rem; overflow-x: auto; }
        .tab { padding: 0.75rem 1.25rem; font-weight: 500; color: var(--gray-500); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.15s; white-space: nowrap; }
        .tab:hover { color: var(--gray-700); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        .timeline { padding: 1rem 0; }
        .timeline-item { display: flex; gap: 1rem; padding-bottom: 1.5rem; position: relative; }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-item:not(:last-child)::before { content: ''; position: absolute; left: 15px; top: 32px; bottom: 0; width: 2px; background: var(--gray-200); }
        .timeline-dot { width: 32px; height: 32px; border-radius: 50%; background: var(--gray-200); display: flex; align-items: center; justify-content: center; flex-shrink: 0; z-index: 1; font-size: 0.875rem; font-weight: 600; color: var(--gray-500); }
        .timeline-dot.success { background: var(--success); color: white; }
        .timeline-dot.pending { background: var(--warning); color: white; }
        .timeline-content { flex: 1; padding-top: 4px; }
        .timeline-title { font-weight: 500; margin-bottom: 0.125rem; }
        .timeline-meta { font-size: 0.875rem; color: var(--gray-500); }
        
        .signature-area { border: 2px dashed var(--primary); border-radius: 12px; padding: 2rem; margin: 1.5rem 0; background: rgba(79, 70, 229, 0.02); text-align: center; }
        .signature-area.signed { border-style: solid; border-color: var(--success); background: rgba(16, 185, 129, 0.02); }
        .signature-label { font-size: 0.875rem; color: var(--gray-500); margin-bottom: 1rem; }
        .signature-canvas-wrap { background: white; border: 1px solid var(--gray-300); border-radius: 8px; margin-bottom: 1rem; display: inline-block; max-width: 100%; overflow: hidden; }
        .signature-canvas { width: 400px; max-width: 100%; height: 150px; cursor: crosshair; touch-action: none; display: block; }
        .signature-actions { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
        .signature-image { max-height: 80px; margin-bottom: 0.5rem; }
        
        .alert { padding: 1rem 1.25rem; border-radius: 8px; margin-bottom: 1rem; display: flex; gap: 0.75rem; align-items: flex-start; }
        .alert-icon { font-size: 1.25rem; flex-shrink: 0; }
        .alert-info { background: #dbeafe; color: #1e40af; }
        .alert-warning { background: var(--warning-light); color: #92400e; }
        .alert-success { background: var(--success-light); color: #065f46; }
        .alert-danger { background: var(--danger-light); color: #991b1b; }
        
        .doc-preview { background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 2rem; font-family: 'Times New Roman', serif; font-size: 11pt; line-height: 1.5; max-height: 500px; overflow-y: auto; }
        .doc-preview h1 { text-align: center; font-size: 16pt; margin-bottom: 0.5rem; font-family: 'Times New Roman', serif; }
        .doc-preview .subtitle { text-align: center; font-size: 9pt; color: #666; margin-bottom: 1.5rem; }
        .doc-preview .section { margin-bottom: 1rem; }
        .doc-preview .section-title { font-weight: bold; }
        .doc-preview .field { border-bottom: 1px solid #000; padding: 0 4px; background: #fffbeb; font-weight: bold; }
        
        .toast-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 1001; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { background: var(--gray-900); color: white; padding: 1rem 1.5rem; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); animation: slideIn 0.3s ease; min-width: 280px; max-width: 400px; }
        .toast-success { background: var(--success); }
        .toast-error { background: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem; background: linear-gradient(135deg, var(--primary-50) 0%, white 100%); }
        .auth-card { background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); padding: 3rem; max-width: 420px; width: 100%; }
        .auth-logo { text-align: center; margin-bottom: 2rem; }
        .auth-title { font-family: 'DM Sans', sans-serif; font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 0.5rem; }
        .auth-subtitle { color: var(--gray-500); text-align: center; margin-bottom: 2rem; }
        .auth-footer { text-align: center; margin-top: 1.5rem; color: var(--gray-500); }
        .auth-footer a { color: var(--primary); text-decoration: none; font-weight: 500; cursor: pointer; }
        .auth-footer a:hover { text-decoration: underline; }
        
        .signing-container { max-width: 900px; margin: 0 auto; padding: 2rem; }
        .signing-header { background: white; border-radius: 12px; border: 1px solid var(--gray-200); padding: 1.5rem; margin-bottom: 1.5rem; }
        
        .empty-state { text-align: center; padding: 4rem 2rem; }
        .empty-state-icon { width: 80px; height: 80px; background: var(--gray-100); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; font-size: 2rem; }
        .empty-state h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .empty-state p { color: var(--gray-500); margin-bottom: 1.5rem; }
        
        .user-menu { position: relative; }
        .user-btn { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; background: var(--gray-100); border: none; border-radius: 9999px; cursor: pointer; font-family: inherit; }
        .user-avatar { width: 32px; height: 32px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.875rem; }
        .user-dropdown { position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background: white; border: 1px solid var(--gray-200); border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); min-width: 200px; z-index: 100; overflow: hidden; }
        .user-dropdown-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; color: var(--gray-700); cursor: pointer; transition: background 0.15s; border: none; background: none; width: 100%; text-align: left; font-family: inherit; font-size: 0.9375rem; }
        .user-dropdown-item:hover { background: var(--gray-50); }
        .user-dropdown-item.danger { color: var(--danger); }
        
        .detail-grid { display: grid; grid-template-columns: 1fr 340px; gap: 1.5rem; }
        .action-bar { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-menu { position: absolute; top: 100%; right: 0; margin-top: 0.25rem; background: white; border: 1px solid var(--gray-200); border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); min-width: 180px; z-index: 100; overflow: hidden; display: none; }
        .dropdown-menu.show { display: block; }
        .dropdown-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1rem; color: var(--gray-700); cursor: pointer; transition: background 0.15s; font-size: 0.875rem; }
        .dropdown-item:hover { background: var(--gray-50); }
        .dropdown-item.danger { color: var(--danger); }
        .dropdown-divider { height: 1px; background: var(--gray-200); margin: 0.25rem 0; }
        
        @media (max-width: 900px) { .detail-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { 
            .sidebar { display: none; }
            .main-content { padding: 1rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // API Helper
        const api = {
            token: localStorage.getItem('leasesign_token'),
            setToken(t) { this.token = t; t ? localStorage.setItem('leasesign_token', t) : localStorage.removeItem('leasesign_token'); },
            async req(url, opts = {}) {
                const headers = { 'Content-Type': 'application/json', ...opts.headers };
                if (this.token) headers['Authorization'] = `Bearer ${this.token}`;
                const res = await fetch(`/api${url}`, { ...opts, headers });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data.error || 'Request failed');
                return data;
            },
            get: (url) => api.req(url),
            post: (url, body) => api.req(url, { method: 'POST', body: JSON.stringify(body) }),
            put: (url, body) => api.req(url, { method: 'PUT', body: JSON.stringify(body) }),
            del: (url) => api.req(url, { method: 'DELETE' })
        };

        // Icons
        const Icon = ({ name, size = 20 }) => {
            const paths = {
                home: 'M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z M9 22V12h6v10',
                folder: 'M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z',
                plus: 'M12 5v14 M5 12h14',
                send: 'M22 2L11 13 M22 2l-7 20-4-9-9-4 20-7z',
                check: 'M20 6L9 17l-5-5',
                download: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3',
                trash: 'M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2',
                user: 'M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8z',
                logout: 'M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-5-5-5 M21 12H9',
                back: 'M19 12H5 M12 19l-7-7 7-7',
                copy: 'M20 9h-9a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2v-9a2 2 0 0 0-2-2z M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1',
                refresh: 'M23 4v6h-6 M1 20v-6h6 M3.51 9a9 9 0 0 1 14.85-3.36L23 10 M1 14l4.64 4.36A9 9 0 0 0 20.49 15',
                x: 'M18 6L6 18 M6 6l12 12',
                more: 'M12 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2z M19 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2z M5 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2z',
                template: 'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z M14 2v6h6 M16 13H8 M16 17H8 M10 9H8',
                ban: 'M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z M4.93 4.93l14.14 14.14'
            };
            return <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d={paths[name]}/></svg>;
        };

        // Signature Pad
        function SignaturePad({ onComplete, signerName }) {
            const canvasRef = useRef(null);
            const [drawing, setDrawing] = useState(false);
            const [hasSig, setHasSig] = useState(false);

            useEffect(() => {
                const ctx = canvasRef.current.getContext('2d');
                ctx.strokeStyle = '#1f2937';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
            }, []);

            const getPos = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const scaleX = canvasRef.current.width / rect.width;
                const scaleY = canvasRef.current.height / rect.height;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
            };

            const start = (e) => { e.preventDefault(); const ctx = canvasRef.current.getContext('2d'); const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); setDrawing(true); };
            const draw = (e) => { if (!drawing) return; e.preventDefault(); const ctx = canvasRef.current.getContext('2d'); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); setHasSig(true); };
            const stop = () => setDrawing(false);
            const clear = () => { canvasRef.current.getContext('2d').clearRect(0, 0, 400, 150); setHasSig(false); };

            return (
                <div className="signature-area">
                    <div className="signature-label">‚úçÔ∏è Sign here: <strong>{signerName}</strong></div>
                    <div className="signature-canvas-wrap">
                        <canvas ref={canvasRef} className="signature-canvas" width={400} height={150}
                            onMouseDown={start} onMouseMove={draw} onMouseUp={stop} onMouseLeave={stop}
                            onTouchStart={start} onTouchMove={draw} onTouchEnd={stop}/>
                    </div>
                    <div className="signature-actions">
                        <button className="btn btn-secondary" onClick={clear}>Clear</button>
                        <button className="btn btn-primary" onClick={() => hasSig && onComplete(canvasRef.current.toDataURL())} disabled={!hasSig}>Adopt & Sign</button>
                    </div>
                    <p style={{fontSize:'0.8rem',color:'var(--gray-500)',marginTop:'1rem'}}>By signing, I agree that this electronic signature is the legal equivalent of my manual signature.</p>
                </div>
            );
        }

        // Toast
        function Toasts({ toasts, remove }) {
            return <div className="toast-container">{toasts.map(t => <div key={t.id} className={`toast toast-${t.type}`} onClick={() => remove(t.id)}>{t.type === 'success' ? '‚úì' : '‚úï'} {t.message}</div>)}</div>;
        }

        // Status Badge
        const StatusBadge = ({ status }) => {
            const cfg = { 
                draft: ['status-draft', 'Draft'], 
                pending: ['status-pending', 'Awaiting Signatures'], 
                partial: ['status-partial', 'Partially Signed'], 
                completed: ['status-completed', 'Completed'],
                voided: ['status-voided', 'Voided'],
                template: ['status-template', 'Template']
            };
            const [cls, label] = cfg[status] || cfg.draft;
            return <span className={`status-badge ${cls}`}><span className="status-dot"></span>{label}</span>;
        };

        // Login Page
        function LoginPage({ onLogin, onSwitch }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const submit = async (e) => {
                e.preventDefault();
                setLoading(true); setError('');
                try {
                    const { token, user } = await api.post('/auth/login', { email, password });
                    api.setToken(token);
                    onLogin(user);
                } catch (err) { setError(err.message); }
                finally { setLoading(false); }
            };

            return (
                <div className="auth-container">
                    <div className="auth-card">
                        <div className="auth-logo"><div className="logo" style={{justifyContent:'center'}}><div className="logo-icon">üìù</div>LeaseSign</div></div>
                        <h1 className="auth-title">Welcome back</h1>
                        <p className="auth-subtitle">Sign in to manage your lease documents</p>
                        {error && <div className="alert alert-danger"><span className="alert-icon">‚ö†Ô∏è</span>{error}</div>}
                        <form onSubmit={submit}>
                            <div className="form-group" style={{marginBottom:'1rem'}}><label>Email</label><input type="email" value={email} onChange={e=>setEmail(e.target.value)} required/></div>
                            <div className="form-group" style={{marginBottom:'1rem'}}><label>Password</label><input type="password" value={password} onChange={e=>setPassword(e.target.value)} required/></div>
                            <button type="submit" className="btn btn-primary btn-lg" style={{width:'100%'}} disabled={loading}>{loading ? 'Signing in...' : 'Sign In'}</button>
                        </form>
                        <div className="auth-footer">Don't have an account? <a onClick={onSwitch}>Create one</a></div>
                    </div>
                </div>
            );
        }

        // Register Page
        function RegisterPage({ onRegister, onSwitch }) {
            const [form, setForm] = useState({ email: '', password: '', name: '', company: '', phone: '' });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const submit = async (e) => {
                e.preventDefault();
                setLoading(true); setError('');
                try {
                    const { token, user } = await api.post('/auth/register', form);
                    api.setToken(token);
                    onRegister(user);
                } catch (err) { setError(err.message); }
                finally { setLoading(false); }
            };

            return (
                <div className="auth-container">
                    <div className="auth-card">
                        <div className="auth-logo"><div className="logo" style={{justifyContent:'center'}}><div className="logo-icon">üìù</div>LeaseSign</div></div>
                        <h1 className="auth-title">Create account</h1>
                        <p className="auth-subtitle">Start managing lease documents today</p>
                        {error && <div className="alert alert-danger"><span className="alert-icon">‚ö†Ô∏è</span>{error}</div>}
                        <form onSubmit={submit}>
                            <div className="form-group" style={{marginBottom:'1rem'}}><label>Full Name *</label><input value={form.name} onChange={e=>setForm({...form,name:e.target.value})} required/></div>
                            <div className="form-group" style={{marginBottom:'1rem'}}><label>Email *</label><input type="email" value={form.email} onChange={e=>setForm({...form,email:e.target.value})} required/></div>
                            <div className="form-group" style={{marginBottom:'1rem'}}><label>Password *</label><input type="password" value={form.password} onChange={e=>setForm({...form,password:e.target.value})} required minLength={6}/></div>
                            <div className="form-group" style={{marginBottom:'1rem'}}><label>Company</label><input value={form.company} onChange={e=>setForm({...form,company:e.target.value})}/></div>
                            <div className="form-group" style={{marginBottom:'1rem'}}><label>Phone</label><input value={form.phone} onChange={e=>setForm({...form,phone:e.target.value})}/></div>
                            <button type="submit" className="btn btn-primary btn-lg" style={{width:'100%'}} disabled={loading}>{loading ? 'Creating...' : 'Create Account'}</button>
                        </form>
                        <div className="auth-footer">Already have an account? <a onClick={onSwitch}>Sign in</a></div>
                    </div>
                </div>
            );
        }

        // Create/Edit Lease Modal
        function CreateModal({ onClose, onCreate, user, template }) {
            const [step, setStep] = useState(1);
            const [form, setForm] = useState({
                title: template?.title || '', 
                landlordName: template?.landlordName || user.name, 
                landlordEmail: template?.landlordEmail || user.email, 
                landlordPhone: template?.landlordPhone || user.phone || '',
                tenantName: template?.tenantName || '', 
                tenantEmail: template?.tenantEmail || '', 
                tenantPhone: template?.tenantPhone || '',
                propertyAddress: template?.propertyAddress || '', 
                propertyCity: template?.propertyCity || '', 
                propertyZip: template?.propertyZip || '', 
                propertyCounty: template?.propertyCounty || '', 
                legalDescription: template?.legalDescription || '',
                commencementDate: template?.commencementDate || '', 
                expirationDate: template?.expirationDate || '', 
                monthlyRent: template?.monthlyRent || '', 
                securityDeposit: template?.securityDeposit || '',
                gracePeriodDay: template?.gracePeriodDay || '3', 
                initialLateFee: template?.initialLateFee || '50', 
                dailyLateFee: template?.dailyLateFee || '25', 
                returnedPaymentFee: template?.returnedPaymentFee || '75',
                paymentName: template?.paymentName || '', 
                paymentAddress: template?.paymentAddress || '', 
                specialProvisions: template?.specialProvisions || ''
            });
            const upd = (k, v) => setForm({ ...form, [k]: v });

            const submit = () => {
                const title = form.title || `Residential Lease - ${form.propertyAddress?.split(',')[0] || 'New Property'}`;
                onCreate({ ...form, title });
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal modal-lg" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">{template ? 'Create from Template' : 'Create New Lease'}</h2>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        <div className="modal-body">
                            <div className="tabs">
                                <div className={`tab ${step===1?'active':''}`} onClick={()=>setStep(1)}>1. Parties</div>
                                <div className={`tab ${step===2?'active':''}`} onClick={()=>setStep(2)}>2. Property</div>
                                <div className={`tab ${step===3?'active':''}`} onClick={()=>setStep(3)}>3. Terms</div>
                                <div className={`tab ${step===4?'active':''}`} onClick={()=>setStep(4)}>4. Fees & Extras</div>
                            </div>

                            {step === 1 && <>
                                <div className="form-section">
                                    <h3 className="form-section-title">üë§ Landlord</h3>
                                    <div className="form-grid">
                                        <div className="form-group"><label>Name *</label><input value={form.landlordName} onChange={e=>upd('landlordName',e.target.value)}/></div>
                                        <div className="form-group"><label>Email *</label><input type="email" value={form.landlordEmail} onChange={e=>upd('landlordEmail',e.target.value)}/></div>
                                        <div className="form-group"><label>Phone</label><input value={form.landlordPhone} onChange={e=>upd('landlordPhone',e.target.value)}/></div>
                                    </div>
                                </div>
                                <div className="form-section">
                                    <h3 className="form-section-title">üë• Tenant</h3>
                                    <div className="form-grid">
                                        <div className="form-group"><label>Name *</label><input value={form.tenantName} onChange={e=>upd('tenantName',e.target.value)}/></div>
                                        <div className="form-group"><label>Email *</label><input type="email" value={form.tenantEmail} onChange={e=>upd('tenantEmail',e.target.value)}/></div>
                                        <div className="form-group"><label>Phone</label><input value={form.tenantPhone} onChange={e=>upd('tenantPhone',e.target.value)}/></div>
                                    </div>
                                </div>
                            </>}

                            {step === 2 && <div className="form-section">
                                <h3 className="form-section-title">üè† Property Details</h3>
                                <div className="form-grid">
                                    <div className="form-group full-width"><label>Street Address *</label><input value={form.propertyAddress} onChange={e=>upd('propertyAddress',e.target.value)} placeholder="123 Main Street"/></div>
                                    <div className="form-group"><label>City *</label><input value={form.propertyCity} onChange={e=>upd('propertyCity',e.target.value)} placeholder="Round Rock"/></div>
                                    <div className="form-group"><label>ZIP *</label><input value={form.propertyZip} onChange={e=>upd('propertyZip',e.target.value)} placeholder="78665"/></div>
                                    <div className="form-group"><label>County *</label><input value={form.propertyCounty} onChange={e=>upd('propertyCounty',e.target.value)} placeholder="Williamson"/></div>
                                    <div className="form-group"><label>Legal Description</label><input value={form.legalDescription} onChange={e=>upd('legalDescription',e.target.value)} placeholder="LOT 6, BLOCK OO, SIENA SEC 14"/></div>
                                </div>
                            </div>}

                            {step === 3 && <div className="form-section">
                                <h3 className="form-section-title">üìã Lease Terms</h3>
                                <div className="form-grid">
                                    <div className="form-group"><label>Monthly Rent ($) *</label><input type="number" value={form.monthlyRent} onChange={e=>upd('monthlyRent',e.target.value)} placeholder="2300"/></div>
                                    <div className="form-group"><label>Security Deposit ($) *</label><input type="number" value={form.securityDeposit} onChange={e=>upd('securityDeposit',e.target.value)} placeholder="2300"/></div>
                                    <div className="form-group"><label>Start Date *</label><input type="date" value={form.commencementDate} onChange={e=>upd('commencementDate',e.target.value)}/></div>
                                    <div className="form-group"><label>End Date *</label><input type="date" value={form.expirationDate} onChange={e=>upd('expirationDate',e.target.value)}/></div>
                                </div>
                            </div>}

                            {step === 4 && <>
                                <div className="form-section">
                                    <h3 className="form-section-title">üí∞ Late Fees</h3>
                                    <div className="form-grid">
                                        <div className="form-group"><label>Grace Period (day)</label><input type="number" value={form.gracePeriodDay} onChange={e=>upd('gracePeriodDay',e.target.value)}/></div>
                                        <div className="form-group"><label>Initial Late Fee ($)</label><input type="number" value={form.initialLateFee} onChange={e=>upd('initialLateFee',e.target.value)}/></div>
                                        <div className="form-group"><label>Daily Late Fee ($)</label><input type="number" value={form.dailyLateFee} onChange={e=>upd('dailyLateFee',e.target.value)}/></div>
                                        <div className="form-group"><label>Returned Payment Fee ($)</label><input type="number" value={form.returnedPaymentFee} onChange={e=>upd('returnedPaymentFee',e.target.value)}/></div>
                                    </div>
                                </div>
                                <div className="form-section">
                                    <h3 className="form-section-title">üìù Payment & Special Provisions</h3>
                                    <div className="form-grid">
                                        <div className="form-group"><label>Payment Recipient</label><input value={form.paymentName} onChange={e=>upd('paymentName',e.target.value)}/></div>
                                        <div className="form-group"><label>Payment Address</label><input value={form.paymentAddress} onChange={e=>upd('paymentAddress',e.target.value)}/></div>
                                        <div className="form-group full-width"><label>Special Provisions</label><textarea rows={4} value={form.specialProvisions} onChange={e=>upd('specialProvisions',e.target.value)} placeholder="Any additional terms..."/></div>
                                    </div>
                                </div>
                            </>}
                        </div>
                        <div className="modal-footer">
                            {step > 1 && <button className="btn btn-secondary" onClick={() => setStep(step - 1)}>Previous</button>}
                            <div style={{flex:1}}/>
                            {step < 4 ? <button className="btn btn-primary" onClick={() => setStep(step + 1)}>Next</button>
                                      : <button className="btn btn-primary" onClick={submit}>Create Lease</button>}
                        </div>
                    </div>
                </div>
            );
        }

        // Confirm Modal
        function ConfirmModal({ title, message, confirmText, confirmStyle, onClose, onConfirm }) {
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal modal-sm" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">{title}</h2>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        <div className="modal-body">
                            <p style={{color:'var(--gray-600)'}}>{message}</p>
                        </div>
                        <div className="modal-footer">
                            <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
                            <button className={`btn btn-${confirmStyle || 'primary'}`} onClick={onConfirm}>{confirmText || 'Confirm'}</button>
                        </div>
                    </div>
                </div>
            );
        }

        // Send Modal
        function SendModal({ doc, onClose, onSend }) {
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Send for Signature</h2>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        <div className="modal-body">
                            <p style={{color:'var(--gray-600)',marginBottom:'1.5rem'}}>Send this lease for electronic signature. Both parties will receive an email with instructions.</p>
                            <div style={{background:'var(--gray-50)',borderRadius:'8px',padding:'1rem',marginBottom:'1rem'}}>
                                <div style={{fontWeight:600,marginBottom:'0.75rem'}}>Signing Order:</div>
                                <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'0.5rem'}}>
                                    <span style={{width:'24px',height:'24px',background:'var(--primary)',color:'white',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'0.75rem',fontWeight:600}}>1</span>
                                    <span><strong>Landlord</strong> ({doc.landlordEmail})</span>
                                </div>
                                <div style={{display:'flex',alignItems:'center',gap:'0.75rem'}}>
                                    <span style={{width:'24px',height:'24px',background:'var(--gray-300)',color:'white',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'0.75rem',fontWeight:600}}>2</span>
                                    <span><strong>Tenant</strong> ({doc.tenantEmail})</span>
                                </div>
                            </div>
                            <div className="alert alert-info"><span className="alert-icon">üìß</span><div><strong>Email Notification</strong><br/><span style={{fontSize:'0.875rem'}}>A signing link will be sent to {doc.landlordEmail}</span></div></div>
                        </div>
                        <div className="modal-footer">
                            <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
                            <button className="btn btn-primary" onClick={onSend}><Icon name="send" size={16}/> Send Now</button>
                        </div>
                    </div>
                </div>
            );
        }

        // Save Template Modal
        function SaveTemplateModal({ doc, onClose, onSave }) {
            const [name, setName] = useState(`Template - ${doc.propertyAddress || 'New'}`);
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal modal-sm" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Save as Template</h2>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        <div className="modal-body">
                            <div className="form-group">
                                <label>Template Name</label>
                                <input value={name} onChange={e => setName(e.target.value)} />
                            </div>
                            <p style={{fontSize:'0.875rem',color:'var(--gray-500)',marginTop:'1rem'}}>Templates save all lease terms except tenant information and signatures.</p>
                        </div>
                        <div className="modal-footer">
                            <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
                            <button className="btn btn-primary" onClick={() => onSave(name)}>Save Template</button>
                        </div>
                    </div>
                </div>
            );
        }

        // Document Detail
        function DocDetail({ doc, onBack, onSend, onDownload, onDelete, onRefresh, onDuplicate, onVoid, onResend, onSaveTemplate, toast }) {
            const [tab, setTab] = useState('preview');
            const [audit, setAudit] = useState([]);
            const [menuOpen, setMenuOpen] = useState(false);

            useEffect(() => {
                api.get(`/documents/${doc.id}/audit`).then(setAudit).catch(() => {});
            }, [doc.id]);

            const field = v => v || '____________';

            const canSend = doc.status === 'draft';
            const canResend = doc.status === 'pending' || doc.status === 'partial';
            const canVoid = doc.status !== 'completed' && doc.status !== 'voided';
            const canDownload = doc.status === 'completed';

            return <>
                <div className="page-header">
                    <div>
                        <button className="btn btn-secondary btn-sm" style={{marginBottom:'1rem'}} onClick={onBack}><Icon name="back" size={16}/> Back</button>
                        <h1 className="page-title">{doc.title || 'Untitled'}</h1>
                        <p className="page-subtitle">{doc.propertyAddress}</p>
                    </div>
                    <div className="action-bar">
                        {canSend && <button className="btn btn-primary" onClick={onSend}><Icon name="send" size={16}/> Send for Signature</button>}
                        {canResend && <button className="btn btn-warning" onClick={onResend}><Icon name="refresh" size={16}/> Send Reminder</button>}
                        {canDownload && <button className="btn btn-success" onClick={onDownload}><Icon name="download" size={16}/> Download PDF</button>}
                        
                        <div className="dropdown">
                            <button className="btn btn-secondary btn-icon" onClick={() => setMenuOpen(!menuOpen)}><Icon name="more" size={20}/></button>
                            {menuOpen && <div className="dropdown-menu show">
                                <div className="dropdown-item" onClick={() => { setMenuOpen(false); onDuplicate(); }}><Icon name="copy" size={16}/> Duplicate</div>
                                <div className="dropdown-item" onClick={() => { setMenuOpen(false); onSaveTemplate(); }}><Icon name="template" size={16}/> Save as Template</div>
                                <div className="dropdown-divider"/>
                                {canVoid && <div className="dropdown-item danger" onClick={() => { setMenuOpen(false); onVoid(); }}><Icon name="ban" size={16}/> Void Document</div>}
                                {doc.status === 'draft' && <div className="dropdown-item danger" onClick={() => { setMenuOpen(false); onDelete(); }}><Icon name="trash" size={16}/> Delete</div>}
                            </div>}
                        </div>
                    </div>
                </div>

                <div className="detail-grid">
                    <div className="card">
                        <div className="card-header"><span className="card-title">Document</span><StatusBadge status={doc.status}/></div>
                        <div className="card-body">
                            <div className="tabs">
                                <div className={`tab ${tab==='preview'?'active':''}`} onClick={()=>setTab('preview')}>Preview</div>
                                <div className={`tab ${tab==='details'?'active':''}`} onClick={()=>setTab('details')}>Details</div>
                                <div className={`tab ${tab==='audit'?'active':''}`} onClick={()=>setTab('audit')}>Audit Log</div>
                            </div>

                            {tab === 'preview' && <div className="doc-preview">
                                <h1>RESIDENTIAL LEASE</h1>
                                <p className="subtitle">Texas Association of REALTORS¬Æ Form</p>
                                <div className="section"><p className="section-title">1. PARTIES:</p><p>Landlord: <span className="field">{field(doc.landlordName)}</span> | Tenant: <span className="field">{field(doc.tenantName)}</span></p></div>
                                <div className="section"><p className="section-title">2. PROPERTY:</p><p>Address: <span className="field">{field(doc.propertyAddress)}, {doc.propertyCity}, TX {doc.propertyZip}</span><br/>County: <span className="field">{field(doc.propertyCounty)}</span></p></div>
                                <div className="section"><p className="section-title">3. TERM:</p><p>From <span className="field">{field(doc.commencementDate)}</span> to <span className="field">{field(doc.expirationDate)}</span></p></div>
                                <div className="section"><p className="section-title">5. RENT:</p><p>Monthly: <span className="field">${field(doc.monthlyRent)}</span></p></div>
                                <div className="section"><p className="section-title">10. SECURITY DEPOSIT:</p><p>Amount: <span className="field">${field(doc.securityDeposit)}</span></p></div>
                                {doc.specialProvisions && <div className="section"><p className="section-title">26. SPECIAL PROVISIONS:</p><p>{doc.specialProvisions}</p></div>}
                                <div className="section" style={{marginTop:'2rem'}}>
                                    <p className="section-title">SIGNATURES:</p>
                                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'2rem',marginTop:'1rem'}}>
                                        <div><p><strong>Landlord:</strong></p>{doc.landlordSignature ? <><img src={doc.landlordSignature} className="signature-image" alt="Landlord Signature"/><p style={{fontSize:'9pt',color:'#666'}}>Signed: {new Date(doc.landlordSignedAt).toLocaleString()}</p></> : <div style={{height:'60px',borderBottom:'1px solid #000',marginTop:'0.5rem'}}/>}<p>{doc.landlordName}</p></div>
                                        <div><p><strong>Tenant:</strong></p>{doc.tenantSignature ? <><img src={doc.tenantSignature} className="signature-image" alt="Tenant Signature"/><p style={{fontSize:'9pt',color:'#666'}}>Signed: {new Date(doc.tenantSignedAt).toLocaleString()}</p></> : <div style={{height:'60px',borderBottom:'1px solid #000',marginTop:'0.5rem'}}/>}<p>{doc.tenantName}</p></div>
                                    </div>
                                </div>
                            </div>}

                            {tab === 'details' && <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',gap:'1rem'}}>
                                <div><strong>Landlord:</strong> {doc.landlordName}</div>
                                <div><strong>Landlord Email:</strong> {doc.landlordEmail}</div>
                                <div><strong>Tenant:</strong> {doc.tenantName}</div>
                                <div><strong>Tenant Email:</strong> {doc.tenantEmail}</div>
                                <div><strong>Property:</strong> {doc.propertyAddress}</div>
                                <div><strong>City/State:</strong> {doc.propertyCity}, TX {doc.propertyZip}</div>
                                <div><strong>County:</strong> {doc.propertyCounty}</div>
                                <div><strong>Monthly Rent:</strong> ${doc.monthlyRent}</div>
                                <div><strong>Security Deposit:</strong> ${doc.securityDeposit}</div>
                                <div><strong>Lease Start:</strong> {doc.commencementDate}</div>
                                <div><strong>Lease End:</strong> {doc.expirationDate}</div>
                                <div><strong>Grace Period:</strong> Day {doc.gracePeriodDay}</div>
                                <div><strong>Initial Late Fee:</strong> ${doc.initialLateFee}</div>
                                <div><strong>Daily Late Fee:</strong> ${doc.dailyLateFee}</div>
                            </div>}

                            {tab === 'audit' && <div>
                                {audit.length === 0 ? <p style={{color:'var(--gray-500)'}}>No audit events yet.</p> :
                                audit.map((a, i) => <div key={i} style={{padding:'0.75rem 0',borderBottom:'1px solid var(--gray-100)'}}>
                                    <div style={{fontWeight:500}}>{a.action.replace(/_/g, ' ')}</div>
                                    <div style={{fontSize:'0.875rem',color:'var(--gray-500)'}}>{a.actor} ‚Ä¢ {new Date(a.timestamp).toLocaleString()} ‚Ä¢ IP: {a.ip}</div>
                                </div>)}
                            </div>}
                        </div>
                    </div>

                    <div>
                        <div className="card" style={{marginBottom:'1.5rem'}}>
                            <div className="card-header"><span className="card-title">Signature Status</span></div>
                            <div className="card-body">
                                <div className="timeline">
                                    <div className="timeline-item">
                                        <div className={`timeline-dot ${doc.landlordSignedAt ? 'success' : doc.status !== 'draft' ? 'pending' : ''}`}>{doc.landlordSignedAt ? '‚úì' : '1'}</div>
                                        <div className="timeline-content">
                                            <div className="timeline-title">Landlord</div>
                                            <div className="timeline-meta">{doc.landlordSignedAt ? `Signed ${new Date(doc.landlordSignedAt).toLocaleString()}` : doc.status === 'draft' ? 'Not sent' : 'Pending'}</div>
                                        </div>
                                    </div>
                                    <div className="timeline-item">
                                        <div className={`timeline-dot ${doc.tenantSignedAt ? 'success' : ''}`}>{doc.tenantSignedAt ? '‚úì' : '2'}</div>
                                        <div className="timeline-content">
                                            <div className="timeline-title">Tenant</div>
                                            <div className="timeline-meta">{doc.tenantSignedAt ? `Signed ${new Date(doc.tenantSignedAt).toLocaleString()}` : doc.tenantEmail}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="card">
                            <div className="card-header"><span className="card-title">Info</span></div>
                            <div className="card-body">
                                <div style={{marginBottom:'1rem'}}><div style={{fontSize:'0.875rem',color:'var(--gray-500)'}}>Created</div><div style={{fontWeight:500}}>{new Date(doc.createdAt).toLocaleDateString()}</div></div>
                                <div style={{marginBottom:'1rem'}}><div style={{fontSize:'0.875rem',color:'var(--gray-500)'}}>Updated</div><div style={{fontWeight:500}}>{new Date(doc.updatedAt).toLocaleDateString()}</div></div>
                                <div><div style={{fontSize:'0.875rem',color:'var(--gray-500)'}}>ID</div><div style={{fontWeight:500,fontSize:'0.65rem',fontFamily:'monospace',wordBreak:'break-all'}}>{doc.id}</div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </>;
        }

        // Dashboard
        function Dashboard({ user, onLogout }) {
            const [view, setView] = useState('dashboard');
            const [docs, setDocs] = useState([]);
            const [templates, setTemplates] = useState([]);
            const [stats, setStats] = useState({});
            const [doc, setDoc] = useState(null);
            const [showCreate, setShowCreate] = useState(false);
            const [showSend, setShowSend] = useState(false);
            const [showVoid, setShowVoid] = useState(false);
            const [showDelete, setShowDelete] = useState(false);
            const [showSaveTemplate, setShowSaveTemplate] = useState(false);
            const [selectedTemplate, setSelectedTemplate] = useState(null);
            const [toasts, setToasts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [menuOpen, setMenuOpen] = useState(false);

            useEffect(() => { loadData(); }, []);

            const loadData = async () => {
                try {
                    const [docsData, statsData, templatesData] = await Promise.all([
                        api.get('/documents'),
                        api.get('/stats'),
                        api.get('/templates')
                    ]);
                    setDocs(docsData.filter(d => !d.isTemplate));
                    setStats(statsData);
                    setTemplates(templatesData);
                } catch (e) { toast(e.message, 'error'); }
                finally { setLoading(false); }
            };

            const toast = (message, type = 'success') => { 
                const id = Date.now(); 
                setToasts(t => [...t, { id, message, type }]); 
                setTimeout(() => setToasts(t => t.filter(x => x.id !== id)), 4000); 
            };

            const createDoc = async (data) => { 
                try { 
                    let d;
                    if (selectedTemplate) {
                        d = await api.post(`/templates/${selectedTemplate.id}/use`, data);
                    } else {
                        d = await api.post('/documents', data);
                    }
                    setDocs([d, ...docs]); 
                    setShowCreate(false); 
                    setSelectedTemplate(null);
                    toast('Lease created!'); 
                    setDoc(d); 
                    setView('detail'); 
                } catch (e) { toast(e.message, 'error'); } 
            };
            
            const sendDoc = async () => { 
                try { 
                    const d = await api.post(`/documents/${doc.id}/send`); 
                    setDocs(docs.map(x => x.id === d.id ? d : x)); 
                    setDoc(d); 
                    setShowSend(false); 
                    toast('Sent for signature!'); 
                } catch (e) { toast(e.message, 'error'); } 
            };
            
            const resendDoc = async () => {
                try {
                    const result = await api.post(`/documents/${doc.id}/resend`);
                    toast(`Reminder sent to ${result.sentTo}`);
                } catch (e) { toast(e.message, 'error'); }
            };
            
            const duplicateDoc = async () => {
                try {
                    const d = await api.post(`/documents/${doc.id}/duplicate`);
                    setDocs([d, ...docs]);
                    toast('Document duplicated!');
                    setDoc(d);
                } catch (e) { toast(e.message, 'error'); }
            };
            
            const voidDoc = async () => {
                try {
                    const d = await api.post(`/documents/${doc.id}/void`, { reason: 'Voided by user' });
                    setDocs(docs.map(x => x.id === d.id ? d : x));
                    setDoc(d);
                    setShowVoid(false);
                    toast('Document voided');
                } catch (e) { toast(e.message, 'error'); }
            };
            
            const deleteDoc = async () => { 
                try { 
                    await api.del(`/documents/${doc.id}`); 
                    setDocs(docs.filter(x => x.id !== doc.id)); 
                    setDoc(null); 
                    setView('dashboard');
                    setShowDelete(false);
                    toast('Deleted'); 
                } catch (e) { toast(e.message, 'error'); } 
            };
            
            const saveAsTemplate = async (name) => {
                try {
                    const t = await api.post('/templates', { documentId: doc.id, name });
                    setTemplates([t, ...templates]);
                    setShowSaveTemplate(false);
                    toast('Template saved!');
                } catch (e) { toast(e.message, 'error'); }
            };
            
            const downloadPdf = () => window.open(`/api/documents/${doc.id}/pdf`, '_blank');

            const activeDocs = docs.filter(d => d.status !== 'voided');

            return <div>
                <nav className="top-nav">
                    <div className="logo" onClick={() => { setView('dashboard'); setDoc(null); }}><div className="logo-icon">üìù</div>LeaseSign</div>
                    <div className="user-menu">
                        <button className="user-btn" onClick={() => setMenuOpen(!menuOpen)}>
                            <div className="user-avatar">{user.name?.charAt(0).toUpperCase()}</div>
                            <span style={{fontWeight:500}}>{user.name}</span>
                        </button>
                        {menuOpen && <div className="user-dropdown">
                            <button className="user-dropdown-item danger" onClick={() => { api.setToken(null); onLogout(); }}><Icon name="logout" size={16}/> Sign Out</button>
                        </div>}
                    </div>
                </nav>

                <div className="app-layout">
                    <aside className="sidebar">
                        <div className="sidebar-label">Menu</div>
                        <div className={`sidebar-item ${view==='dashboard'&&!doc?'active':''}`} onClick={() => { setView('dashboard'); setDoc(null); }}><Icon name="home"/> Dashboard</div>
                        <div className={`sidebar-item ${view==='documents'?'active':''}`} onClick={() => { setView('documents'); setDoc(null); }}><Icon name="folder"/> All Documents {activeDocs.length > 0 && <span className="sidebar-badge">{activeDocs.length}</span>}</div>
                        <div className={`sidebar-item ${view==='templates'?'active':''}`} onClick={() => { setView('templates'); setDoc(null); }}><Icon name="template"/> Templates {templates.length > 0 && <span className="sidebar-badge">{templates.length}</span>}</div>
                        <div className="sidebar-label">Actions</div>
                        <div className="sidebar-item" onClick={() => { setSelectedTemplate(null); setShowCreate(true); }}><Icon name="plus"/> New Lease</div>
                    </aside>

                    <main className="main-content">
                        {view === 'detail' && doc ? (
                            <DocDetail 
                                doc={doc} 
                                onBack={() => { setView('dashboard'); setDoc(null); }} 
                                onSend={() => setShowSend(true)} 
                                onDownload={downloadPdf} 
                                onDelete={() => setShowDelete(true)}
                                onDuplicate={duplicateDoc}
                                onVoid={() => setShowVoid(true)}
                                onResend={resendDoc}
                                onSaveTemplate={() => setShowSaveTemplate(true)}
                                toast={toast}
                            />
                        ) : view === 'templates' ? (
                            <>
                                <div className="page-header">
                                    <div><h1 className="page-title">Templates</h1><p className="page-subtitle">Reusable lease templates</p></div>
                                </div>
                                <div className="card">
                                    <div className="card-header"><span className="card-title">My Templates</span></div>
                                    {templates.length === 0 ? (
                                        <div className="empty-state">
                                            <div className="empty-state-icon">üìã</div>
                                            <h3>No templates yet</h3>
                                            <p>Save a document as a template to reuse it</p>
                                        </div>
                                    ) : (
                                        <div className="doc-list">
                                            {templates.map(t => (
                                                <div key={t.id} className="doc-item" onClick={() => { setSelectedTemplate(t); setShowCreate(true); }}>
                                                    <div className="doc-icon template">üìã</div>
                                                    <div className="doc-info">
                                                        <div className="doc-title">{t.templateName || 'Untitled Template'}</div>
                                                        <div className="doc-meta">{t.propertyAddress || 'No address'} ‚Ä¢ {new Date(t.createdAt).toLocaleDateString()}</div>
                                                    </div>
                                                    <button className="btn btn-primary btn-sm">Use Template</button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </>
                        ) : (
                            <>
                                <div className="page-header">
                                    <div><h1 className="page-title">{view === 'documents' ? 'All Documents' : 'Dashboard'}</h1><p className="page-subtitle">Manage your lease documents</p></div>
                                    <button className="btn btn-primary btn-lg" onClick={() => { setSelectedTemplate(null); setShowCreate(true); }}><Icon name="plus" size={18}/> New Lease</button>
                                </div>

                                {view === 'dashboard' && <div className="stats-grid">
                                    <div className="stat-card"><div className="stat-icon blue">üìÑ</div><div className="stat-label">Total</div><div className="stat-value">{stats.total || 0}</div></div>
                                    <div className="stat-card"><div className="stat-icon yellow">‚è≥</div><div className="stat-label">Awaiting</div><div className="stat-value">{(stats.pending || 0) + (stats.partial || 0)}</div></div>
                                    <div className="stat-card"><div className="stat-icon green">‚úì</div><div className="stat-label">Completed</div><div className="stat-value">{stats.completed || 0}</div></div>
                                    <div className="stat-card"><div className="stat-icon gray">üìù</div><div className="stat-label">Drafts</div><div className="stat-value">{stats.draft || 0}</div></div>
                                    <div className="stat-card"><div className="stat-icon purple">üìã</div><div className="stat-label">Templates</div><div className="stat-value">{templates.length}</div></div>
                                    <div className="stat-card"><div className="stat-icon red">üö´</div><div className="stat-label">Voided</div><div className="stat-value">{stats.voided || 0}</div></div>
                                </div>}

                                <div className="card">
                                    <div className="card-header"><span className="card-title">{view === 'documents' ? 'All Documents' : 'Recent Documents'}</span></div>
                                    {loading ? <div className="card-body" style={{textAlign:'center',padding:'3rem'}}>Loading...</div>
                                    : activeDocs.length === 0 ? <div className="empty-state"><div className="empty-state-icon">üìÑ</div><h3>No documents yet</h3><p>Create your first lease document</p><button className="btn btn-primary" onClick={() => { setSelectedTemplate(null); setShowCreate(true); }}><Icon name="plus" size={16}/> Create Lease</button></div>
                                    : <div className="doc-list">{(view === 'documents' ? activeDocs : activeDocs.slice(0, 10)).map(d => (
                                        <div key={d.id} className="doc-item" onClick={() => { setDoc(d); setView('detail'); }}>
                                            <div className="doc-icon">üìã</div>
                                            <div className="doc-info"><div className="doc-title">{d.title || 'Untitled'}</div><div className="doc-meta">{d.tenantName || 'No tenant'} ‚Ä¢ {new Date(d.createdAt).toLocaleDateString()}</div></div>
                                            <StatusBadge status={d.status}/>
                                        </div>
                                    ))}</div>}
                                </div>
                            </>
                        )}
                    </main>
                </div>

                {showCreate && <CreateModal onClose={() => { setShowCreate(false); setSelectedTemplate(null); }} onCreate={createDoc} user={user} template={selectedTemplate}/>}
                {showSend && doc && <SendModal doc={doc} onClose={() => setShowSend(false)} onSend={sendDoc}/>}
                {showVoid && <ConfirmModal title="Void Document" message="Are you sure you want to void this document? This action cannot be undone. The signing links will no longer work." confirmText="Void Document" confirmStyle="danger" onClose={() => setShowVoid(false)} onConfirm={voidDoc}/>}
                {showDelete && <ConfirmModal title="Delete Document" message="Are you sure you want to delete this document? This action cannot be undone." confirmText="Delete" confirmStyle="danger" onClose={() => setShowDelete(false)} onConfirm={deleteDoc}/>}
                {showSaveTemplate && doc && <SaveTemplateModal doc={doc} onClose={() => setShowSaveTemplate(false)} onSave={saveAsTemplate}/>}
                <Toasts toasts={toasts} remove={id => setToasts(t => t.filter(x => x.id !== id))}/>
            </div>;
        }

        // Public Signing Page
        function SigningPage({ token }) {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [signing, setSigning] = useState(false);
            const [done, setDone] = useState(false);

            useEffect(() => {
                fetch(`/api/sign/${token}`).then(r => r.json()).then(d => { if (d.error) throw new Error(d.error); setData(d); }).catch(e => setError(e.message)).finally(() => setLoading(false));
            }, [token]);

            const submit = async (sig) => {
                setSigning(true);
                try {
                    const res = await fetch(`/api/sign/${token}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ signature: sig }) });
                    const d = await res.json();
                    if (!res.ok) throw new Error(d.error);
                    setDone(true);
                } catch (e) { setError(e.message); }
                finally { setSigning(false); }
            };

            if (loading) return <div className="auth-container"><div className="auth-card" style={{textAlign:'center'}}>Loading...</div></div>;
            if (error) return <div className="auth-container"><div className="auth-card" style={{textAlign:'center'}}><div style={{fontSize:'3rem',marginBottom:'1rem'}}>‚ö†Ô∏è</div><h2>Error</h2><p style={{color:'var(--gray-500)'}}>{error}</p></div></div>;
            if (done) return <div className="auth-container"><div className="auth-card" style={{textAlign:'center'}}><div style={{fontSize:'3rem',marginBottom:'1rem'}}>‚úÖ</div><h2>Signed Successfully!</h2><p style={{color:'var(--gray-500)'}}>You'll receive a copy via email once all parties have signed.</p></div></div>;

            const { document: doc, signerType } = data;
            const signerName = signerType === 'landlord' ? doc.landlordName : doc.tenantName;
            const field = v => v || '____________';

            return <div style={{background:'var(--gray-100)',minHeight:'100vh'}}>
                <nav className="top-nav"><div className="logo"><div className="logo-icon">üìù</div>LeaseSign</div><span style={{color:'var(--gray-500)'}}>Signing as: {signerName}</span></nav>
                <div className="signing-container">
                    <div className="signing-header"><h2 style={{fontFamily:"'DM Sans',sans-serif",fontWeight:700}}>üñäÔ∏è Review & Sign</h2><p style={{color:'var(--gray-500)'}}>{doc.propertyAddress}</p></div>
                    <div className="card">
                        <div className="card-header"><span className="card-title">Residential Lease Agreement</span></div>
                        <div className="card-body">
                            <div className="doc-preview" style={{maxHeight:'400px'}}>
                                <h1>RESIDENTIAL LEASE</h1>
                                <p className="subtitle">Texas Association of REALTORS¬Æ Form</p>
                                <div className="section"><p className="section-title">1. PARTIES:</p><p>Landlord: <span className="field">{field(doc.landlordName)}</span> | Tenant: <span className="field">{field(doc.tenantName)}</span></p></div>
                                <div className="section"><p className="section-title">2. PROPERTY:</p><p><span className="field">{field(doc.propertyAddress)}</span>, {doc.propertyCounty} County, TX</p></div>
                                <div className="section"><p className="section-title">3. TERM:</p><p>From <span className="field">{field(doc.commencementDate)}</span> to <span className="field">{field(doc.expirationDate)}</span></p></div>
                                <div className="section"><p className="section-title">5. RENT:</p><p>Monthly: <span className="field">${field(doc.monthlyRent)}</span></p></div>
                                <div className="section"><p className="section-title">10. SECURITY DEPOSIT:</p><p><span className="field">${field(doc.securityDeposit)}</span></p></div>
                            </div>
                            <SignaturePad signerName={signerName} onComplete={submit}/>
                            {signing && <p style={{textAlign:'center',color:'var(--gray-500)'}}>Submitting...</p>}
                        </div>
                    </div>
                </div>
            </div>;
        }

        // App
        function App() {
            const [user, setUser] = useState(null);
            const [authView, setAuthView] = useState('login');
            const [loading, setLoading] = useState(true);

            const signToken = window.location.pathname.match(/^\/sign\/(.+)$/)?.[1];

            useEffect(() => {
                if (signToken) { setLoading(false); return; }
                const token = localStorage.getItem('leasesign_token');
                if (token) {
                    api.token = token;
                    api.get('/auth/me').then(setUser).catch(() => localStorage.removeItem('leasesign_token')).finally(() => setLoading(false));
                } else { setLoading(false); }
            }, []);

            if (loading) return <div className="auth-container"><div>Loading...</div></div>;
            if (signToken) return <SigningPage token={signToken}/>;
            if (!user) return authView === 'register' ? <RegisterPage onRegister={setUser} onSwitch={() => setAuthView('login')}/> : <LoginPage onLogin={setUser} onSwitch={() => setAuthView('register')}/>;
            return <Dashboard user={user} onLogout={() => setUser(null)}/>;
        }

        ReactDOM.render(<App/>, document.getElementById('root'));
    </script>
</body>
</html>
